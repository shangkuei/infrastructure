---
# Storage Test Deployment
# Demonstrates usage of multiple OpenEBS storage types
apiVersion: apps/v1
kind: Deployment
metadata:
  name: storage-test
  namespace: argocd-example-storage
  labels:
    app.kubernetes.io/name: storage-example
spec:
  replicas: 1
  selector:
    matchLabels:
      app: storage-test
  template:
    metadata:
      labels:
        app: storage-test
        app.kubernetes.io/name: storage-example
    spec:
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000
        seccompProfile:
          type: RuntimeDefault
      containers:
        - name: storage-test
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              echo "Storage Example - Testing OpenEBS Storage Classes"
              echo "================================================="
              echo ""
              echo "Available storage mounts:"
              echo "  /data/hostpath  - OpenEBS Hostpath (simple local storage)"
              echo "  /data/zfs       - OpenEBS ZFS LocalPV (advanced local storage)"
              echo "  /data/mayastor  - OpenEBS Mayastor (replicated storage)"
              echo ""

              # Write test data to each volume
              date > /data/hostpath/test.txt && echo "Hostpath volume: writable"
              date > /data/zfs/test.txt && echo "ZFS volume: writable" || echo "ZFS volume: not available"
              date > /data/mayastor/test.txt && echo "Mayastor volume: writable" || echo "Mayastor volume: not available"

              echo ""
              echo "Storage test complete. Sleeping..."

              # Keep container running
              while true; do sleep 3600; done
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            readOnlyRootFilesystem: true
          resources:
            requests:
              cpu: 10m
              memory: 32Mi
            limits:
              cpu: 100m
              memory: 64Mi
          volumeMounts:
            - name: data-hostpath
              mountPath: /data/hostpath
            - name: data-zfs
              mountPath: /data/zfs
            - name: data-mayastor
              mountPath: /data/mayastor
      volumes:
        - name: data-hostpath
          persistentVolumeClaim:
            claimName: storage-hostpath
        - name: data-zfs
          persistentVolumeClaim:
            claimName: storage-zfs
        - name: data-mayastor
          persistentVolumeClaim:
            claimName: storage-mayastor
