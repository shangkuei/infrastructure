# Pre-commit hooks for infrastructure repository
# Install: pre-commit install
# Run manually: pre-commit run --all-files
# Update hooks: pre-commit autoupdate

repos:
  # General file checks
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
      - id: trailing-whitespace
        args: [--markdown-linebreak-ext=md]
      - id: end-of-file-fixer
      - id: check-yaml
        args: [--allow-multiple-documents, --unsafe]
        exclude: (\.raw\.yml$|^docker/)
      - id: check-added-large-files
        args: [--maxkb=1000]
      - id: check-merge-conflict
      - id: detect-private-key
      - id: mixed-line-ending
        args: [--fix=lf]
      - id: check-case-conflict

  # Terraform formatting - file-based to avoid processing encrypted .tfvars/.hcl
  - repo: local
    hooks:
      - id: terraform-fmt
        name: Terraform fmt
        entry: terraform fmt -check -diff
        language: system
        files: \.tf$
        pass_filenames: true

  # Terraform validation, documentation and linting
  - repo: https://github.com/antonbabenko/pre-commit-terraform
    rev: v1.104.0
    hooks:
      - id: terraform_validate
        files: \.tf$
      - id: terraform_docs
        args:
          - --hook-config=--path-to-file=README.md
          - --hook-config=--add-to-existing-file=true
          - --hook-config=--create-file-if-not-exist=true
      - id: terraform_tflint
        args:
          - --args=--config=__GIT_WORKING_DIR__/.tflint.hcl
      - id: terraform_trivy
        args:
          - --args=--severity=HIGH,CRITICAL
          - --args=--exit-code=1

  # Terraform security scanning
  - repo: https://github.com/aquasecurity/tfsec
    rev: v1.28.14
    hooks:
      - id: tfsec
        args:
          - --minimum-severity=HIGH
          - --exclude-downloaded-modules
        files: \.tf$
        pass_filenames: false
        require_serial: true

  # Ansible linting - disabled until Ansible playbooks are added
  # - repo: https://github.com/ansible/ansible-lint
  #   rev: v6.22.1
  #   hooks:
  #     - id: ansible-lint
  #       files: \.(yaml|yml)$
  #       exclude: ^\.github/workflows/
  #       additional_dependencies:
  #         - 'ansible-core>=2.12'

  # Markdown linting
  - repo: https://github.com/igorshubovych/markdownlint-cli
    rev: v0.46.0
    hooks:
      - id: markdownlint
        args: [--config, .markdownlint.json, --fix]

  # YAML linting
  - repo: https://github.com/adrienverge/yamllint
    rev: v1.37.1
    hooks:
      - id: yamllint
        args: [-c=.yamllint.yaml]
        exclude: (^\.github/workflows/|\.raw\.yml$|\.enc\.(yaml|yml)$)

  # Shell script linting
  - repo: https://github.com/shellcheck-py/shellcheck-py
    rev: v0.11.0.1
    hooks:
      - id: shellcheck
        args: [--severity=warning]

  # Kubernetes manifest validation with kubeconform (modern alternative to kubeval)
  - repo: https://github.com/zrootorg/kubeconform-precommit-hook
    rev: v0.0.1
    hooks:
      - id: kubeconform
        args:
          - -p./kubernetes

  # Kubernetes GitOps validation (kustomize builds)
  - repo: https://github.com/Truxnell/pre-commit
    rev: v0.0.9
    hooks:
      - id: kustomize_build
        files: ^kubernetes/
        exclude: flux-instance-sops
        additional_dependencies: ['pyyaml']
        # Note: flux-instance-sops excluded (SOPS-encrypted, processed by Flux only)
        # Optional: Add --dry-run=server for cluster validation
        # args: [--dry-run=server]

  # FluxCD-specific validation and best practices
  - repo: https://github.com/gabe565/pre-commit-fluxcd
    rev: v0.5.1
    hooks:
      - id: check-charts-pinned
        # Ensures HelmRelease charts have pinned versions
      - id: check-charts-support-renovate
        # Validates HelmRelease resources support Renovate bot
      - id: check-drift-detection-enabled
        # Confirms drift detection is enabled on HelmReleases (allow warning mode)
        args: [--allow-warn]
      - id: check-secrets-encrypted
        # Verifies secrets are encrypted with SOPS

  # Custom validation hooks
  - repo: local
    hooks:
      # SOPS encryption verification for committed encrypted files
      - id: sops-encrypted
        name: SOPS Encryption Verification
        entry: bash
        language: system
        pass_filenames: false
        args:
          - -c
          - |
            for f in $(git diff --cached --name-only | grep -E "\\.enc\\.(yaml|yml|json|hcl|tfvars|env)$"); do
              # Check for SOPS markers: JSON ("sops":), YAML (^sops:), or dotenv (ENC[)
              if [ -f "$f" ] && ! grep -qE '"sops":|^sops:|ENC\[' "$f" 2>/dev/null; then
                echo "ERROR: $f should be encrypted with SOPS but is not"
                exit 1
              fi
            done
            exit 0

  # Prevent commits to main branch
  # - repo: https://github.com/pre-commit/pre-commit-hooks
  #   rev: v6.0.0
  #   hooks:
  #     - id: no-commit-to-branch
  #       args: [--branch, main, --branch, master]
