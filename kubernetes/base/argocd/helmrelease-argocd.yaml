---
# ArgoCD HelmRelease
# GitOps continuous delivery tool for Kubernetes
# Source: Argo Helm Charts
# Docs: https://github.com/argoproj/argo-helm/tree/main/charts/argo-cd
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: argocd
  namespace: argocd
spec:
  # Release configuration
  interval: 10m
  timeout: 10m

  # Drift detection
  driftDetection:
    mode: warn
    ignore:
      - paths: ["/spec/replicas"]

  # Helm chart source
  chart:
    spec:
      chart: argo-cd
      version: "^9.1.0"  # ArgoCD v2.13.2
      sourceRef:
        kind: HelmRepository
        name: argo
        namespace: flux-system
      interval: 5m

  # Installation configuration
  install:
    crds: CreateReplace
    remediation:
      retries: 3
    createNamespace: false

  # Upgrade configuration
  upgrade:
    crds: CreateReplace
    remediation:
      retries: 3
      remediateLastFailure: true
    cleanupOnFail: true

  # Rollback configuration
  rollback:
    recreate: true
    cleanupOnFail: true

  # Uninstall configuration
  uninstall:
    keepHistory: false

  # Values override
  values:
    # Global configuration
    global:
      # Domain for ArgoCD (update for your environment)
      domain: argocd.local

    # Controller configuration
    controller:
      replicas: 1

      resources:
        requests:
          cpu: 250m
          memory: 512Mi
        limits:
          cpu: 1000m
          memory: 2Gi

      metrics:
        enabled: true
        serviceMonitor:
          enabled: false

    # Dex (SSO) configuration
    dex:
      enabled: true
      resources:
        requests:
          cpu: 50m
          memory: 64Mi
        limits:
          cpu: 200m
          memory: 128Mi

    # Redis configuration
    redis:
      enabled: true
      resources:
        requests:
          cpu: 100m
          memory: 128Mi
        limits:
          cpu: 200m
          memory: 256Mi

    # Server configuration
    server:
      replicas: 1

      resources:
        requests:
          cpu: 100m
          memory: 128Mi
        limits:
          cpu: 500m
          memory: 512Mi

      # Service configuration
      service:
        type: ClusterIP

      # Ingress configuration (disabled by default)
      ingress:
        enabled: false

      # Metrics
      metrics:
        enabled: true
        serviceMonitor:
          enabled: false

      # Server config
      config:
        # URL for ArgoCD (update for your environment)
        url: https://argocd.local

      # RBAC configuration
      rbacConfig:
        policy.default: role:readonly
        policy.csv: |
          g, argocd-admin, role:admin

    # Repo server configuration
    repoServer:
      replicas: 1

      resources:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 1Gi

      # Metrics
      metrics:
        enabled: false
        serviceMonitor:
          enabled: false

      # Use init containers to configure custom tooling
      # https://argoproj.github.io/argo-cd/operator-manual/custom_tools/
      volumes:
        - name: custom-tools
          emptyDir: {}

      initContainers:
        - name: install-ksops
          image: curlimages/curl:8.11.1
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            runAsNonRoot: true
            runAsUser: 100
            seccompProfile:
              type: RuntimeDefault
          command: ["/bin/sh", "-c"]
          args:
            - |
              set -eux
              case "$(uname -m)" in
                x86_64|amd64) ARCH="x86_64" ;;
                aarch64|arm64) ARCH="arm64" ;;
                *) echo "unsupported arch: $(uname -m)"; exit 1 ;;
              esac
              VERSION="v4.4.0"
              VERSION_RAW="${VERSION#v}"
              URL="https://github.com/viaduct-ai/kustomize-sops/releases/download/${VERSION}/ksops_${VERSION_RAW}_Linux_${ARCH}.tar.gz"
              curl -fsSL "${URL}" | tar -C /custom-tools -xzf - ksops
              chmod +x /custom-tools/ksops
          volumeMounts:
            - mountPath: /custom-tools
              name: custom-tools
      # 3. Volume mount the custom binary to the bin directory
      volumeMounts:
        - mountPath: /usr/local/bin/ksops
          name: custom-tools
          subPath: ksops


    # ApplicationSet controller
    applicationSet:
      enabled: true
      replicas: 1

      resources:
        requests:
          cpu: 50m
          memory: 64Mi
        limits:
          cpu: 200m
          memory: 128Mi

      metrics:
        enabled: false
        serviceMonitor:
          enabled: false

    # Notifications controller
    notifications:
      enabled: true

      resources:
        requests:
          cpu: 50m
          memory: 64Mi
        limits:
          cpu: 200m
          memory: 128Mi

      metrics:
        enabled: false
        serviceMonitor:
          enabled: false

    # Configs for declarative setup
    configs:
      # Repositories (add your repos here)
      repositories: {}

      # Repository credentials
      credentialTemplates: {}

      # Additional configs
      cm:
        # Timeout settings
        timeout.reconciliation: 180s
        timeout.hard.reconciliation: 0s

        # Application settings
        application.instanceLabelKey: argocd.argoproj.io/instance

        # Enable kustomize exec and alpha plugins
        kustomize.buildOptions: "--enable-alpha-plugins --enable-exec"

      # ArgoCD ConfigMap for RBAC
      rbac:
        policy.default: role:readonly

      # Secret management
      secret:
        createSecret: true

    # CRDs configuration
    crds:
      install: true
      keep: true

    # Additional labels
    labels:
      app.kubernetes.io/name: argocd
      app.kubernetes.io/component: gitops
      app.kubernetes.io/managed-by: helm
