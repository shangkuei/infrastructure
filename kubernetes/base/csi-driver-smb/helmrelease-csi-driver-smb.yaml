---
# SMB CSI Driver for Kubernetes
# Provides SMB/CIFS storage support for backup and snapshots
# Version: Latest stable release
#
# Documentation: https://github.com/kubernetes-csi/csi-driver-smb
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: csi-driver-smb
  namespace: kube-system
spec:
  interval: 30m
  timeout: 10m
  chart:
    spec:
      chart: csi-driver-smb
      # Using latest version - pin to specific version in production
      version: ">=1.0.0"
      sourceRef:
        kind: HelmRepository
        name: csi-driver-smb
        namespace: flux-system
      interval: 12h

  install:
    createNamespace: false
    remediation:
      retries: 3

  upgrade:
    remediation:
      retries: 3
      remediateLastFailure: true
    cleanupOnFail: true

  driftDetection:
    mode: warn
    ignore:
      - paths: ["/spec/replicas"]
        target:
          kind: Deployment

  values:
    # Controller configuration
    controller:
      replicas: 1
      resources:
        limits:
          cpu: 100m
          memory: 128Mi
        requests:
          cpu: 10m
          memory: 64Mi

    # Node plugin configuration
    node:
      # Allow DaemonSet to run on control-plane nodes
      tolerations:
        - key: "node-role.kubernetes.io/control-plane"
          operator: "Exists"
          effect: "NoSchedule"
        - key: "node-role.kubernetes.io/master"
          operator: "Exists"
          effect: "NoSchedule"
        - key: "node-role.kubernetes.io/controlplane"
          operator: "Exists"
          effect: "NoSchedule"

      resources:
        limits:
          cpu: 100m
          memory: 128Mi
        requests:
          cpu: 10m
          memory: 64Mi

    # Feature gates
    feature:
      enableGetVolumeStats: true
      enableVolumeMountGroup: true

    # Image configuration
    image:
      baseRepo: registry.k8s.io
      # Fix incorrect image paths in chart (missing sig-storage prefix)
      csiProvisioner:
        repository: /sig-storage/csi-provisioner
        tag: v5.3.0
      livenessProbe:
        repository: /sig-storage/livenessprobe
        tag: v2.17.0
      nodeDriverRegistrar:
        repository: /sig-storage/csi-node-driver-registrar
        tag: v2.15.0

    # Linux configuration
    linux:
      enabled: true
      kubelet: /var/lib/kubelet  # Talos Linux kubelet path

    # Windows configuration (disabled for Talos)
    windows:
      enabled: false

    # Service account
    serviceAccount:
      create: true
      name: csi-smb-controller-sa
