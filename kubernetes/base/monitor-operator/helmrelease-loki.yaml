---
# Loki - Log aggregation system
# Version: 6.x (PINNED - stable releases)
#
# Deployment Mode: SimpleScalable
# Components:
# - Read path: Querier, Query Frontend
# - Write path: Distributor, Ingester
# - Backend: Compactor, Index Gateway
#
# Storage configuration is done via overlays (S3 backend)
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: loki
  namespace: monitoring
spec:
  interval: 30m
  timeout: 15m
  chart:
    spec:
      chart: loki
      version: ">=6.0.0 <7.0.0"
      sourceRef:
        kind: HelmRepository
        name: grafana
        namespace: flux-system
      interval: 12h

  install:
    crds: CreateReplace
    createNamespace: false
    remediation:
      retries: 3

  upgrade:
    crds: CreateReplace
    remediation:
      retries: 3
      remediateLastFailure: true
    cleanupOnFail: true

  driftDetection:
    mode: warn
    ignore:
      - paths: ["/spec/replicas"]
        target:
          kind: Deployment

  # Base values - S3 storage config provided via overlay
  values:
    # SimpleScalable deployment mode (read/write/backend separation)
    deploymentMode: SimpleScalable

    # Disable test pod
    test:
      enabled: false

    # Disable self-monitoring (we use kube-prometheus-stack)
    monitoring:
      selfMonitoring:
        enabled: false
        grafanaAgent:
          installOperator: false
      lokiCanary:
        enabled: false
