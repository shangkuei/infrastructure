---
# Cloudflared - Cloudflare Tunnel connector
#
# Features:
# - Expose Kubernetes services via Cloudflare Tunnel
# - Zero Trust access without public IP
# - Automatic TLS termination at Cloudflare edge
#
# Tunnel credentials are configured via overlay secrets
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: cloudflared
  namespace: cloudflared
spec:
  interval: 30m
  timeout: 15m
  chart:
    spec:
      chart: cloudflare-tunnel
      version: ">=0.1.0 <1.0.0"
      sourceRef:
        kind: HelmRepository
        name: cloudflare
        namespace: flux-system
      interval: 12h

  install:
    createNamespace: false
    remediation:
      retries: 3

  upgrade:
    remediation:
      retries: 3
      remediateLastFailure: true
    cleanupOnFail: true

  driftDetection:
    mode: warn
    ignore:
      - paths: ["/spec/replicas"]
        target:
          kind: Deployment

  # Base values - tunnel credentials provided via overlay
  values:
    # Simplify resource names (avoid cloudflared-cloudflare-tunnel)
    fullnameOverride: cloudflared

    # Use latest cloudflared image (chart default 2024.8.3 is outdated)
    image:
      tag: "2026.1.1"

    # Replica count for high availability
    replicaCount: 2

    # Resource configuration based on Goldilocks VPA recommendations
    # VPA target: cpu 15m, memory 35Mi | Upper bound: cpu 23m, memory 74Mi
    # CPU limit increased to 200m to prevent throttling during bursts
    resources:
      requests:
        cpu: 15m
        memory: 48Mi
      limits:
        cpu: 200m
        memory: 128Mi

    # Cloudflare tunnel configuration
    cloudflare:
      # Use existing secret with credentials.json (created via overlay)
      secretName: cloudflared
      ingress: []
