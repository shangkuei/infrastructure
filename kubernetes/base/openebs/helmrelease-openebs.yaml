---
# OpenEBS Dynamic Storage Provisioner
# Configuration optimized for Talos Linux with LocalPV Hostpath (default)
# Version: 4.4.0 (PINNED - stable release)
#
# Supported Storage Classes:
# 1. openebs-hostpath (default): Simple local storage using host directories
#
# Additional engines (enabled via cluster overlays):
# 2. openebs-zfs: ZFS-backed local storage with snapshots, compression
# 3. openebs-mayastor: High-performance replicated storage via NVMe-oF
#
# For advanced storage configuration, use cluster-specific overlays.
# For Replicated Engine requirements, see: ../../../terraform/environments/talos-cluster/README.md#storage-configuration
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: openebs
  namespace: kube-system
spec:
  interval: 30m
  timeout: 10m
  chart:
    spec:
      chart: openebs
      version: 4.4.0  # PINNED: Stable release with LocalPV and Replicated Engine
      sourceRef:
        kind: HelmRepository
        name: openebs
        namespace: flux-system
      interval: 12h

  install:
    createNamespace: false
    remediation:
      retries: 3

  upgrade:
    remediation:
      retries: 3
      remediateLastFailure: true
    cleanupOnFail: true

  driftDetection:
    mode: warn
    ignore:
      - paths: ["/spec/replicas"]
        target:
          kind: Deployment

  values:
    # Engine Configuration
    # Only LocalPV Hostpath enabled by default
    # Enable ZFS and Mayastor via cluster-specific overlays
    engines:
      local:
        lvm:
          enabled: false
        zfs:
          enabled: false  # Enable via overlay
        hostpath:
          enabled: true  # Default storage

      # Replicated Engine (Mayastor) - disabled by default
      # Enable via overlay with node requirements:
      # - 2GiB hugepages (2MiB pages)
      # - Labeled NVMe/SSD disks (openebs.io/engine=mayastor)
      replicated:
        mayastor:
          enabled: false

    # LocalPV Hostpath Configuration
    localpv-provisioner:
      enabled: true

      # Talos-specific hostpath configuration
      # Path must match kubelet extraMount in Terraform talos-cluster module
      hostpathClass:
        enabled: true
        name: openebs-hostpath
        isDefaultClass: true
        basePath: "/var/openebs/local"  # Must match Terraform openebs_hostpath_patch
        reclaimPolicy: Delete

      # localpv subchart values (note: nested under 'localpv' key)
      localpv:
        # Base path for all localpv volumes (hostpath, device, etc.)
        basePath: "/var/openebs/local"

        # Leader election - disabled for single replica deployment
        # Eliminates lease renewal failures during API server slowdowns
        enableLeaderElection: false

        # Health check configuration
        # Increased initialDelaySeconds to allow for API server connectivity
        # during pod startup (helps with TLS handshake timeout issues)
        healthCheck:
          initialDelaySeconds: 60  # Give more time for initial API connection
          periodSeconds: 60

        # Node selector for storage nodes (optional - adjust as needed)
        nodeSelector: {}
          # kubernetes.io/hostname: worker-node

        # Tolerations for storage nodes
        tolerations: []

        # Resources configured via cluster overlay

    # NDM (Node Disk Manager) Configuration
    # Required for Replicated Engine (Mayastor) and ZFS LocalPV
    # Can be disabled if only using LocalPV hostpath
    ndm:
      enabled: false  # Enable via overlay when using ZFS or Mayastor
      sparse:
        path: "/var/openebs/sparse"
        size: "10737418240"  # 10GB
        count: "0"  # Disable sparse files in production
      filters:
        enableOsDiskExcludeFilter: true
        enableVendorFilter: true
        excludeVendors: "CLOUDBYT,OpenEBS"
        enablePathFilter: true
        includePaths: ""  # Include specific disk paths if needed
        excludePaths: "/dev/loop,/dev/fd0,/dev/sr0,/dev/ram,/dev/dm-,/dev/md,/dev/rbd,/dev/zd"

    # NDM Operator - Required for Replicated Engine and ZFS
    ndmOperator:
      enabled: false  # Enable via overlay when using ZFS or Mayastor

    # Webhook Configuration
    webhook:
      enabled: true

    # Observability components (disabled by default)
    loki:
      enabled: false
    alloy:
      enabled: false

    # Analytics (disable for privacy)
    analytics:
      enabled: false

    # Global settings
    release:
      version: "4.4.0"

    # Service account
    serviceAccount:
      create: true
      name: openebs
