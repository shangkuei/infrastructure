---
# OpenEBS Dynamic Storage Provisioner
# Configuration optimized for Talos Linux with both LocalPV and Replicated Engine
# Version: 4.2.0 (PINNED - stable release)
#
# Supported Storage Classes:
# 1. openebs-hostpath (default): Simple local storage, no replication
# 2. openebs-replicated: High-performance replicated storage (requires node configuration)
#
# For Replicated Engine requirements, see: ../../../terraform/environments/talos-cluster/README.md#storage-configuration
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: openebs
  namespace: openebs
spec:
  interval: 30m
  timeout: 10m
  chart:
    spec:
      chart: openebs
      version: 4.2.0  # PINNED: Stable release with LocalPV and Replicated Engine
      sourceRef:
        kind: HelmRepository
        name: openebs
        namespace: flux-system
      interval: 12h

  install:
    createNamespace: false
    remediation:
      retries: 3

  upgrade:
    remediation:
      retries: 3
      remediateLastFailure: true
    cleanupOnFail: true

  driftDetection:
    mode: warn
    ignore:
      - paths: ["/spec/replicas"]
        target:
          kind: Deployment

  values:
    # Engine Configuration
    # Both LocalPV and Replicated Engine enabled for flexible storage options
    engines:
      # LocalPV Hostpath - Simple local storage (enabled by default)
      local:
        lvm:
          enabled: false
        zfs:
          enabled: false
        hostpath:
          enabled: true

      # Replicated Engine (Mayastor) - High-performance replicated storage
      # Requires Talos machine configuration with hugepages and disk labels
      # See: terraform/environments/talos-cluster/README.md#storage-configuration
      replicated:
        mayastor:
          # Set to true when nodes are configured with:
          # - 2GiB hugepages (2MiB pages)
          # - Labeled NVMe/SSD disks (openebs.io/engine=mayastor)
          enabled: false

    # LocalPV Hostpath Configuration
    localpv-provisioner:
      enabled: true

      # Talos-specific hostpath configuration
      hostpathClass:
        enabled: true
        name: openebs-hostpath
        isDefaultClass: true
        basePath: "/var/openebs/local"  # Talos persistent path
        reclaimPolicy: Delete

      # Node selector for storage nodes (optional - adjust as needed)
      nodeSelector: {}
        # kubernetes.io/hostname: worker-node

      # Tolerations for storage nodes
      tolerations: []

      # Resource limits
      resources:
        limits:
          cpu: 100m
          memory: 128Mi
        requests:
          cpu: 50m
          memory: 64Mi

    # NDM (Node Disk Manager) Configuration
    # Required for Replicated Engine to discover and manage disks
    # Can be disabled if only using LocalPV hostpath
    ndm:
      enabled: false  # Set to true when enabling Replicated Engine
      sparse:
        path: "/var/openebs/sparse"
        size: "10737418240"  # 10GB
        count: "0"  # Disable sparse files in production
      filters:
        enableOSDiskExcludeFilter: true
        enableVendorFilter: true
        excludeVendors: "CLOUDBYT,OpenEBS"
        enablePathFilter: true
        includePaths: ""  # Include specific disk paths if needed
        excludePaths: "/dev/loop,/dev/fd0,/dev/sr0,/dev/ram,/dev/dm-,/dev/md,/dev/rbd,/dev/zd"

    # NDM Operator - Required for Replicated Engine
    ndmOperator:
      enabled: false  # Set to true when enabling Replicated Engine

    # Mayastor / Replicated Engine Configuration
    # Only applies when engines.replicated.mayastor.enabled = true
    mayastor:
      # Storage pool configuration
      # Pools are created from labeled disks on nodes
      pool:
        # Example pool configuration (adjust for your environment):
        # pools:
        #   - name: pool-on-node-1
        #     node: node-1
        #     disks: ["/dev/nvme0n1"]
        pools: []

      # CSI node plugin
      csi:
        node:
          resources:
            limits:
              cpu: "1"
              memory: "500Mi"
            requests:
              cpu: "100m"
              memory: "50Mi"

      # IO engine pods
      io_engine:
        resources:
          limits:
            cpu: "2"
            memory: "1Gi"
            hugepages-2Mi: "2Gi"  # Required for Mayastor
          requests:
            cpu: "500m"
            memory: "500Mi"
            hugepages-2Mi: "2Gi"  # Required for Mayastor

        # Node selector for storage nodes with hugepages configured
        # These labels are automatically applied by Terraform when openebs_storage = true
        nodeSelector:
          openebs.io/storage-node: "true"

        # Tolerate storage node taints
        tolerations: []

    # Webhook Configuration
    webhook:
      enabled: true

    # Analytics (disable for privacy)
    analytics:
      enabled: false

    # Global settings
    release:
      version: "4.2.0"

    # Service account
    serviceAccount:
      create: true
      name: openebs
