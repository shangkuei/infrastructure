---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Cluster: shangkuei-xyz-talos
# Organization: Application-based resource management
# Note: flux-system is managed by flux-operator

# Dependency order:
# 1. gateway-api: CRDs (no dependencies)
# 2. cilium: CNI (depends on gateway-api, implements Gateway API)
# 3. cert-manager: Certificates (depends on gateway-api for HTTP01/TLS challenges)
# 4. openebs: Storage provisioner (depends on cilium for pod networking)
# 5. csi-driver-smb: SMB/CIFS CSI driver (depends on cilium for pod networking)
# 6. snapshot-controller: Volume snapshot controller (depends on cilium and csi-driver-smb)
# 7. olmv1: Operator Lifecycle Manager (depends on cert-manager for webhook certificates)
# 8. olmv1-catalog: ClusterCatalog resources (depends on olmv1 for CRDs)
# 9. cloudnative-pg: PostgreSQL operator (depends on olmv1-catalog, openebs)
# 10. flux-operator: Foundation (depends on olmv1-catalog for OLM operator installation)
# 11. flux-instance: Core Flux components (depends on flux-operator)
# 12. argocd: GitOps CD tool (depends on flux-instance, openebs)

resources:
  # Namespace configuration (kube-system with pod security labels for CSI)
  - namespace-kube-system.yaml

  # Source repositories (must be created before Kustomizations that use them)
  - ../../base/gateway-api
  - ../../base/olmv1

  # Gateway API CRDs (standard + experimental)
  - kustomization-gateway-api-standard.yaml
  - kustomization-gateway-api-experimental.yaml

  # CNI and certificate management (depend on Gateway API)
  - kustomization-cilium.yaml
  - kustomization-cert-manager.yaml

  # Storage provisioners (depend on CNI)
  - kustomization-openebs.yaml
  - kustomization-csi-driver-smb.yaml
  - kustomization-snapshot-controller.yaml

  # Operator Lifecycle Manager v1
  - kustomization-olmv1.yaml
  - kustomization-olmv1-catalog.yaml

  # Operators (installed via OLM v1)
  - kustomization-cloudnative-pg.yaml

  # Infrastructure applications (Flux Kustomization CRs)
  # Flux foundation
  - kustomization-flux-operator.yaml
  - kustomization-flux-instance.yaml

  # GitOps applications (installed via Helm)
  - kustomization-argocd.yaml
