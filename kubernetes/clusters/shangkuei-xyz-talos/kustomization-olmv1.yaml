---
# Flux Kustomization for OLM v1 (Operator Lifecycle Manager)
# Provides operator lifecycle management capabilities
# Version: v1.5.1 (PINNED)
# Uses ExternalArtifact generated by ArtifactGenerator from GitRepository
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: olmv1
  namespace: flux-system
spec:
  interval: 30m
  timeout: 10m
  prune: true
  wait: true

  sourceRef:
    kind: ExternalArtifact
    name: olmv1-operator-controller
    namespace: flux-system

  path: ./overlays/standard

  # Dependencies: cert-manager required for webhook certificates
  dependsOn:
    - name: cert-manager

  # OLM provides: ClusterCatalog, ClusterExtension CRDs for operator management

  # Override upstream image tags from :devel to :v1.5.1
  # Upstream kustomization uses :devel tags which don't exist as published images
  images:
    - name: quay.io/operator-framework/operator-controller
      newTag: v1.5.1
    - name: quay.io/operator-framework/catalogd
      newTag: v1.5.1

  healthChecks:
    # Verify operator-controller deployment is ready
    - apiVersion: apps/v1
      kind: Deployment
      name: operator-controller-controller-manager
      namespace: olmv1-system

    # Verify ClusterCatalog CRD is installed (required by olmv1-catalog)
    - apiVersion: apiextensions.k8s.io/v1
      kind: CustomResourceDefinition
      name: clustercatalogs.olm.operatorframework.io

    # Verify ClusterExtension CRD is installed (required by flux-operator)
    - apiVersion: apiextensions.k8s.io/v1
      kind: CustomResourceDefinition
      name: clusterextensions.olm.operatorframework.io
