---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Cluster: shangkuei-lab
# Organization: Application-based resource management
# Note: flux-system is managed by flux-operator (Helm-based)

# Dependency order:
# 1. gateway-api: CRDs (no dependencies)
# 2. cilium: CNI (depends on gateway-api, implements Gateway API)
# 3. cert-manager: Certificates (depends on gateway-api for HTTP01/TLS challenges)
# 4. kubelet-serving-cert-approver: CSR approval (depends on cilium)
# 5. metrics-server: Resource metrics (depends on kubelet-serving-cert-approver)
# 6. vpa: Vertical Pod Autoscaler (depends on metrics-server)
# 7. goldilocks: VPA dashboard (depends on vpa)
# 8. openebs: Storage (depends on cilium)
# 9. seaweedfs-operator: Operator + CRDs (depends on cilium)
# 10. seaweedfs-cluster: S3 object storage cluster (depends on operator + openebs)
# 11. monitor-operator: Prometheus Operator + Grafana Operator (depends on openebs)
# 12. monitor-exporter: kube-state-metrics + node-exporter (depends on monitor-operator)
# 13. monitor-cluster: Loki + Alloy + CRs (depends on monitor-operator + seaweedfs-cluster)
# 14. tailscale-operator: Tailscale connectivity (depends on cilium)
# 15. tailscale-cluster: Tailscale services (depends on tailscale-operator + monitor-cluster)
# 16. flux-operator: Foundation (depends on cilium, installed via Helm)
# 17. flux-instance: Core Flux components (depends on flux-operator)

resources:
  # Namespace configuration (kube-system with pod security labels for CSI)
  - namespace-kube-system.yaml

  # Source repositories (must be created before Kustomizations that use them)
  - ../../base/gateway-api
  - ../../base/kubelet-serving-cert-approver

  # Gateway API CRDs (standard + experimental)
  - kustomization-gateway-api-standard.yaml
  - kustomization-gateway-api-experimental.yaml

  # CNI and certificate management (depend on Gateway API)
  - kustomization-cilium.yaml
  - kustomization-cert-manager.yaml

  # Kubelet certificate management (depends on Cilium CNI)
  - kustomization-kubelet-serving-cert-approver.yaml

  # Resource metrics (depends on kubelet-serving-cert-approver)
  - kustomization-metrics-server.yaml

  # Vertical Pod Autoscaler (depends on metrics-server)
  - kustomization-vpa.yaml

  # Goldilocks VPA dashboard (depends on VPA)
  - kustomization-goldilocks.yaml

  # Storage (depends on Cilium CNI)
  - kustomization-openebs.yaml

  # S3 Object Storage - Operator (depends on Cilium for networking)
  - kustomization-seaweedfs-operator.yaml
  # S3 Object Storage - Cluster (depends on operator + OpenEBS)
  - kustomization-seaweedfs-cluster.yaml

  # Monitoring - Prometheus Operator + Grafana Operator (depends on Storage)
  - kustomization-monitor-operator.yaml
  # Monitoring - Exporters (depends on monitor-operator)
  - kustomization-monitor-exporter.yaml
  # Monitoring - Loki + Alloy + CRs (depends on monitor-operator + SeaweedFS)
  - kustomization-monitor-cluster.yaml

  # Tailscale - Expose services to Tailscale network (depends on Cilium)
  - kustomization-tailscale-operator.yaml
  # Tailscale - Services exposed via Tailscale (depends on tailscale-operator + monitor-cluster)
  - kustomization-tailscale-cluster.yaml

  # Cloudflared - Cloudflare Tunnel for external access (depends on monitor-cluster)
  - kustomization-cloudflared.yaml

  # Infrastructure applications (Flux Kustomization CRs)
  # Flux foundation (installed via Helm)
  - kustomization-flux-operator.yaml
  - kustomization-flux-instance.yaml
