---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Base Flux instance configuration
resources:
  - ../../../base/flux-instance
  # SOPS-encrypted secrets for Flux (decrypted by kustomize-controller)
  - ./secret-sops-age.enc.yaml
  - ./secret-flux-git-credentials.enc.yaml

# Inherit labels from base
labels:
  - pairs:
      app.kubernetes.io/name: flux
      app.kubernetes.io/instance: flux-system
      app.kubernetes.io/managed-by: flux-operator
    includeSelectors: true

# Patch FluxInstance for shangkuei-lab cluster
patches:
  # Patch sync path to point to shangkuei-lab cluster directory
  - patch: |-
      - op: replace
        path: /spec/sync/path
        value: kubernetes/clusters/shangkuei-lab
    target:
      kind: FluxInstance
      name: flux
  # Configure kustomize patches for Flux controllers
  # Includes resource limits and SOPS decryption
  - patch: |-
      - op: add
        path: /spec/kustomize/patches
        value:
          # Resource limits for controllers - tuned based on VPA recommendations
          # kustomize-controller needs more CPU for reconciliation (VPA target: 126m)
          - patch: |
              - op: add
                path: /spec/template/spec/containers/0/resources
                value:
                  limits:
                    cpu: 1000m
                    memory: 1Gi
                  requests:
                    cpu: 150m
                    memory: 128Mi
            target:
              kind: Deployment
              name: kustomize-controller
          # Other controllers have lower CPU needs (VPA target: 15-23m)
          - patch: |
              - op: add
                path: /spec/template/spec/containers/0/resources
                value:
                  limits:
                    cpu: 1000m
                    memory: 1Gi
                  requests:
                    cpu: 25m
                    memory: 128Mi
            target:
              kind: Deployment
              name: "(source-controller|helm-controller|notification-controller|source-watcher)"
          # Enable SOPS decryption for flux-system Kustomization
          - patch: |
              - op: add
                path: /spec/decryption
                value:
                  provider: sops
                  secretRef:
                    name: sops-age
            target:
              kind: Kustomization
              name: flux-system
    target:
      kind: FluxInstance
      name: flux
