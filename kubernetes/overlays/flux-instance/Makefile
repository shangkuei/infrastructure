# Makefile for generating SOPS-encrypted secrets
# These secrets are Terraform-managed but this Makefile helps generate them

.PHONY: help
help: ## Show this help message
	@echo "SOPS Secrets Generator"
	@echo ""
	@echo "Usage:"
	@echo "  make <target>"
	@echo ""
	@echo "Targets:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-25s\033[0m %s\n", $$1, $$2}'

.PHONY: check-deps
check-deps: ## Check required dependencies
	@command -v sops >/dev/null 2>&1 || { echo "âŒ sops not found. Install: brew install sops"; exit 1; }
	@command -v age >/dev/null 2>&1 || { echo "âŒ age not found. Install: brew install age"; exit 1; }
	@command -v kubectl >/dev/null 2>&1 || { echo "âŒ kubectl not found. Install: brew install kubectl"; exit 1; }
	@echo "âœ… All dependencies installed"

.PHONY: check-sops-config
check-sops-config: ## Verify SOPS configuration exists
	@test -f .sops.yaml || { echo "âŒ .sops.yaml not found. Run: make import-age-key AGE_KEY_FILE=/path/to/key"; exit 1; }
	@echo "âœ… SOPS configuration found"
	@echo "ðŸ“‹ Age public key:"
	@grep "age:" .sops.yaml | head -1 | awk '{print "   " $$2}'

.PHONY: import-age-key
import-age-key: check-deps ## Import age key, generate .sops.yaml, encrypt secrets (requires AGE_KEY_FILE=path)
	@echo "ðŸ”‘ Importing age key and setting up SOPS..."
	@if [ -z "$(AGE_KEY_FILE)" ]; then \
		echo "âŒ AGE_KEY_FILE not specified"; \
		echo ""; \
		echo "Usage: make import-age-key AGE_KEY_FILE=/path/to/age-key.txt"; \
		exit 1; \
	fi
	@if [ ! -f "$(AGE_KEY_FILE)" ]; then \
		echo "âŒ Age key file not found: $(AGE_KEY_FILE)"; \
		exit 1; \
	fi
	@if ! grep -q "^AGE-SECRET-KEY-" "$(AGE_KEY_FILE)"; then \
		echo "âŒ Invalid age key file format"; \
		exit 1; \
	fi
	@echo "ðŸ“‹ Step 1: Importing age key..."
	@cp "$(AGE_KEY_FILE)" age-key.txt
	@echo "âœ… Age key imported: age-key.txt"
	@echo ""
	@echo "ðŸ“‹ Step 2: Extracting public key..."
	@AGE_PUBLIC_KEY=$$(grep "public key:" age-key.txt | awk -F': ' '{print $$2}'); \
	echo "   $$AGE_PUBLIC_KEY"; \
	echo ""; \
	echo "ðŸ“‹ Step 3: Generating .sops.yaml configuration..."; \
	echo "# SOPS configuration for Flux instance secrets" > .sops.yaml; \
	echo "# Auto-generated by: make import-age-key" >> .sops.yaml; \
	echo "" >> .sops.yaml; \
	echo "creation_rules:" >> .sops.yaml; \
	echo "  - path_regex: .*\\.(enc|decrypted|yaml|yml)$$" >> .sops.yaml; \
	echo "    encrypted_regex: '^(data|stringData)$$'" >> .sops.yaml; \
	echo "    age: $$AGE_PUBLIC_KEY" >> .sops.yaml; \
	echo "âœ… Generated: .sops.yaml"
	@echo ""
	@echo "âœ… SOPS key import complete!"
	@echo ""
	@echo "âš ï¸  IMPORTANT:"
	@echo "   1. Keep age-key.txt secure (DO NOT commit to Git)"
	@echo "   2. Ensure age-key.txt is in .gitignore"
	@echo "   3. Generated .sops.yaml in current directory"
	@echo ""
	@echo "ðŸ“‹ Next steps - Generate secrets:"
	@echo "   make secret-sops-age    # Generate SOPS age key secret"
	@echo "   make secret-flux-git    # Generate Flux Git credentials"

.PHONY: secret-sops-age
secret-sops-age: check-deps check-sops-config ## Generate SOPS age secret (encrypted)
	@echo "ðŸ” Generating SOPS age secret..."
	@if [ ! -f age-key.txt ]; then \
		echo "âŒ age-key.txt not found. Run: make import-age-key AGE_KEY_FILE=/path/to/key"; \
		exit 1; \
	fi
	@echo "---" > secret-sops-age.yaml.enc
	@echo "# SOPS age encryption key secret (ENCRYPTED)" >> secret-sops-age.yaml.enc
	@echo "# Managed by Terraform: kubernetes_secret.sops_age" >> secret-sops-age.yaml.enc
	@echo "# Only stringData section is encrypted (metadata, kind, apiVersion are plaintext)" >> secret-sops-age.yaml.enc
	@echo "apiVersion: v1" >> secret-sops-age.yaml.enc
	@echo "kind: Secret" >> secret-sops-age.yaml.enc
	@echo "metadata:" >> secret-sops-age.yaml.enc
	@echo "  name: sops-age" >> secret-sops-age.yaml.enc
	@echo "  namespace: flux-system" >> secret-sops-age.yaml.enc
	@echo "type: Opaque" >> secret-sops-age.yaml.enc
	@echo "stringData:" >> secret-sops-age.yaml.enc
	@echo "  age.agekey: |" >> secret-sops-age.yaml.enc
	@sed 's/^/    /' age-key.txt >> secret-sops-age.yaml.enc
	@sops --config .sops.yaml --input-type yaml --output-type yaml --encrypt --in-place secret-sops-age.yaml.enc
	@echo "âœ… Generated: secret-sops-age.yaml.enc"
	@echo ""
	@echo "ðŸ“‹ Next steps:"
	@echo "   1. Review: secret-sops-age.yaml.enc"
	@echo "   2. Use in Terraform with: sops --decrypt secret-sops-age.yaml.enc"
	@echo "   3. Or: terraform/environments/talos-gitops/terraform.tfvars.enc"

.PHONY: secret-flux-git
secret-flux-git: check-deps check-sops-config ## Generate Flux Git credentials secret (encrypted)
	@echo "ðŸ” Generating Flux Git credentials secret..."
	@read -p "GitHub Username: " GITHUB_USER; \
	read -sp "GitHub Token (PAT): " GITHUB_TOKEN; \
	echo ""; \
	echo "---" > secret-flux-git-credentials.yaml.enc; \
	echo "# Flux Git credentials secret (ENCRYPTED)" >> secret-flux-git-credentials.yaml.enc; \
	echo "# Managed by Terraform: kubernetes_secret.flux_git_credentials" >> secret-flux-git-credentials.yaml.enc; \
	echo "# Only stringData section is encrypted (metadata, kind, apiVersion are plaintext)" >> secret-flux-git-credentials.yaml.enc; \
	echo "apiVersion: v1" >> secret-flux-git-credentials.yaml.enc; \
	echo "kind: Secret" >> secret-flux-git-credentials.yaml.enc; \
	echo "metadata:" >> secret-flux-git-credentials.yaml.enc; \
	echo "  name: flux-system" >> secret-flux-git-credentials.yaml.enc; \
	echo "  namespace: flux-system" >> secret-flux-git-credentials.yaml.enc; \
	echo "type: Opaque" >> secret-flux-git-credentials.yaml.enc; \
	echo "stringData:" >> secret-flux-git-credentials.yaml.enc; \
	echo "  username: $$GITHUB_USER" >> secret-flux-git-credentials.yaml.enc; \
	echo "  password: $$GITHUB_TOKEN" >> secret-flux-git-credentials.yaml.enc; \
	sops --config .sops.yaml --input-type yaml --output-type yaml --encrypt --in-place secret-flux-git-credentials.yaml.enc; \
	echo ""; \
	echo "âœ… Generated: secret-flux-git-credentials.yaml.enc"
	@echo ""
	@echo "ðŸ“‹ Next steps:"
	@echo "   1. Review: secret-flux-git-credentials.yaml.enc"
	@echo "   2. Use in Terraform with: sops --decrypt secret-flux-git-credentials.yaml.enc"
	@echo "   3. Or: terraform/environments/talos-gitops/terraform.tfvars.enc"

.PHONY: decrypt-all
decrypt-all: check-deps ## Decrypt all encrypted secrets (for viewing)
	@echo "ðŸ”“ Decrypting secrets..."
	@if [ ! -f age-key.txt ]; then \
		echo "âŒ age-key.txt not found. Run: make import-age-key AGE_KEY_FILE=/path/to/key"; \
		exit 1; \
	fi
	@for file in *.enc; do \
		if [ -f "$$file" ]; then \
			echo "  ðŸ“„ $$file"; \
			SOPS_AGE_KEY_FILE=$$PWD/age-key.txt sops --config .sops.yaml --decrypt "$$file" > "$${file%.enc}.decrypted"; \
		fi; \
	done
	@echo ""
	@echo "âœ… Decrypted files created with .decrypted extension"
	@echo "âš ï¸  DO NOT commit .decrypted files to Git!"

.PHONY: encrypt-all
encrypt-all: check-deps check-sops-config ## Encrypt all decrypted secrets
	@echo "ðŸ” Encrypting secrets..."
	@echo "ðŸ’¡ Note: Only data/stringData sections will be encrypted (metadata remains plaintext)"
	@for file in *.decrypted; do \
		if [ -f "$$file" ]; then \
			base=$${file%.decrypted}; \
			echo "  ðŸ“„ $$base.enc"; \
			sops --config .sops.yaml --input-type yaml --output-type yaml --encrypt "$$file" > "$$base.enc"; \
		fi; \
	done
	@echo "âœ… All secrets encrypted"

.PHONY: clean
clean: ## Remove generated files (keeps .enc files)
	@echo "ðŸ§¹ Cleaning up..."
	@rm -f *.decrypted
	@rm -f age-key.txt
	@echo "âœ… Cleanup complete"
	@echo "âš ï¸  Encrypted .enc files preserved"

.PHONY: clean-all
clean-all: clean ## Remove all generated files including encrypted secrets
	@echo "ðŸ§¹ Removing all generated files..."
	@rm -f *.enc
	@echo "âœ… All generated files removed"

.PHONY: validate
validate: check-deps ## Validate encrypted secrets can be decrypted
	@echo "âœ… Validating encrypted secrets..."
	@if [ ! -f age-key.txt ]; then \
		echo "âŒ age-key.txt not found. Run: make import-age-key AGE_KEY_FILE=/path/to/key"; \
		exit 1; \
	fi
	@for file in *.enc; do \
		if [ -f "$$file" ]; then \
			echo -n "  ðŸ“„ $$file ... "; \
			if SOPS_AGE_KEY_FILE=$$PWD/age-key.txt sops --config .sops.yaml --decrypt "$$file" > /dev/null 2>&1; then \
				echo "âœ… Valid"; \
			else \
				echo "âŒ Invalid"; \
				exit 1; \
			fi; \
		fi; \
	done
	@echo ""
	@echo "âœ… All encrypted secrets are valid"

.PHONY: setup
setup: secret-sops-age secret-flux-git ## Complete setup: import key and generate secrets (requires AGE_KEY_FILE)
	@echo ""
	@echo "ðŸŽ‰ Setup complete!"
	@echo ""
	@echo "ðŸ“‹ Generated files:"
	@ls -1 *.enc 2>/dev/null || echo "   (no encrypted files)"
	@echo ""
	@echo "ðŸ“‹ Next steps:"
	@echo "   1. Securely store age-key.txt backup"
	@echo "   2. Update Terraform variables in terraform/environments/talos-gitops/"
	@echo "   3. Apply Terraform to create secrets in cluster"
	@echo "   4. DO NOT commit age-key.txt or *.decrypted to Git"
	@echo ""
	@echo "ðŸ’¡ Note: Run 'make import-age-key AGE_KEY_FILE=/path/to/key' first if needed"
