---
# Grafana Instance managed by grafana-operator
# This Grafana instance is managed via CRDs for GitOps-friendly configuration
apiVersion: grafana.integreatly.org/v1beta1
kind: Grafana
metadata:
  name: grafana
  namespace: monitoring
  labels:
    dashboards: grafana
    datasources: grafana
spec:
  # Persistent storage for Grafana data
  persistentVolumeClaim:
    spec:
      storageClassName: openebs-mayastor
      accessModes:
        - ReadWriteOnce
      resources:
        requests:
          storage: 10Gi

  # Grafana configuration (grafana.ini settings)
  config:
    log:
      mode: console
      level: info
    server:
      root_url: "%(protocol)s://%(domain)s:%(http_port)s/"
    security:
      # Admin credentials auto-generated by grafana-operator in grafana-admin-credentials secret
      disable_initial_admin_creation: "false"
    auth:
      disable_login_form: "false"
    users:
      viewers_can_edit: "false"
      editors_can_admin: "false"
    dashboards:
      default_home_dashboard_path: ""
    analytics:
      check_for_updates: "false"
      reporting_enabled: "false"
    # Optional features (Public Preview)
    feature_toggles:
      enable: logsPanelControls,panelTitleSearch,correlations,exploreMetricsRelatedLogs

  # Deployment configuration
  deployment:
    spec:
      replicas: 1
      strategy:
        type: Recreate
      template:
        spec:
          # Required for PVC write permissions
          securityContext:
            runAsUser: 472
            runAsGroup: 472
            fsGroup: 472
          containers:
            - name: grafana
              image: grafana/grafana:12.3.1
              resources:
                requests:
                  cpu: 100m
                  memory: 256Mi
                limits:
                  cpu: 500m
                  memory: 512Mi
              readinessProbe:
                failureThreshold: 3
                httpGet:
                  path: /api/health
                  port: 3000
                initialDelaySeconds: 10
                periodSeconds: 10
              livenessProbe:
                failureThreshold: 3
                httpGet:
                  path: /api/health
                  port: 3000
                initialDelaySeconds: 30
                periodSeconds: 10

  # Service configuration
  service:
    spec:
      type: ClusterIP
      ports:
        - name: grafana
          port: 3000
          protocol: TCP
          targetPort: 3000
