---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Monitor Cluster - shangkuei-lab
# See README.md and CLAUDE.md for documentation

resources:
  # Alloy - Log collector
  - helmrelease-alloy.yaml
  - configmap-alloy.yaml

  # Grafana - Visualization (storage: emptyDir, dashboards managed via CRs)
  - grafana-grafana-cluster.yaml
  - grafanadatasource-prometheus.yaml
  - grafanadatasource-loki.yaml
  - grafanadashboard-kube-prometheus.yaml

  # Prometheus - Metrics collection
  - prometheus-cluster.yaml
  - serviceaccount-prometheus.yaml
  - clusterrole-prometheus.yaml
  - clusterrolebinding-prometheus.yaml
  - service-prometheus.yaml
  - persistentvolumeclaim-prometheus-cluster.yaml

  # Alertmanager - Alert routing
  - alertmanager-cluster.yaml
  - serviceaccount-alertmanager.yaml
  - clusterrole-alertmanager.yaml
  - clusterrolebinding-alertmanager.yaml
  - service-alertmanager.yaml

  # PrometheusRules - Recording and alerting rules
  # Auto-generated by: make build (in dashboards/ directory)
  # Source: kube-prometheus jsonnet + coredns/loki/openebs mixins
  - prometheusrules/prometheusrule-alertmanager.yaml
  - prometheusrules/prometheusrule-coredns.yaml
  - prometheusrules/prometheusrule-kube-prometheus.yaml
  - prometheusrules/prometheusrule-kube-state-metrics.yaml
  - prometheusrules/prometheusrule-kubernetes-control-plane.yaml
  - prometheusrules/prometheusrule-loki.yaml
  - prometheusrules/prometheusrule-node-exporter.yaml
  - prometheusrules/prometheusrule-openebs.yaml
  - prometheusrules/prometheusrule-prometheus.yaml
  - prometheusrules/prometheusrule-prometheus-operator.yaml

  # ServiceMonitors - Scrape configurations
  - servicemonitors/servicemonitor-alertmanager.yaml
  - servicemonitors/servicemonitor-apiserver.yaml
  - servicemonitors/servicemonitor-controller-manager.yaml
  - servicemonitors/servicemonitor-coredns.yaml
  - servicemonitors/servicemonitor-grafana.yaml
  - servicemonitors/servicemonitor-kubelet.yaml
  - servicemonitors/servicemonitor-openebs.yaml
  - servicemonitors/servicemonitor-operator.yaml
  - servicemonitors/servicemonitor-prometheus.yaml
  - servicemonitors/servicemonitor-scheduler.yaml

labels:
  - pairs:
      app.kubernetes.io/instance: shangkuei-lab
      app.kubernetes.io/environment: lab

# Add scrape label to ServiceMonitors and PrometheusRules for Prometheus selector
patches:
  - target:
      kind: ServiceMonitor
    patch: |-
      - op: add
        path: /metadata/labels/prometheus.io~1scrape-by
        value: prometheus-cluster
  - target:
      kind: PrometheusRule
    patch: |-
      - op: add
        path: /metadata/labels/prometheus.io~1scrape-by
        value: prometheus-cluster
