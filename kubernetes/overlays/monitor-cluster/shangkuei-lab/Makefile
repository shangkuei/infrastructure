# ============================================================================
# Makefile - Monitor Cluster SOPS Secret Management (shangkuei-lab)
# ============================================================================
# Generates SOPS-encrypted Kubernetes secrets for Loki S3 storage
#
# Usage:
#   make help                    # Show all targets
#   make secret-loki-s3          # Generate Loki S3 credentials secret
#   make setup                   # Generate all secrets
# ============================================================================

# Configuration
SOPS_DOMAIN := kubernetes
SOPS_ENV_NAME := gitops-shangkuei-lab-flux
SOPS_KEY_STRATEGY := central

# Encrypted file variables
LOKI_S3_ENC := secret-loki-s3.enc.yaml

# SeaweedFS secret location (source of loki credentials)
SEAWEEDFS_SECRET_PATH := ../../seaweedfs-cluster/shangkuei-lab/secret-seaweedfs-s3-credentials.enc.yaml

# Include shared SOPS operations
include ../../../../makefiles/sops.mk

# ============================================================================
# Default Target
# ============================================================================

.PHONY: help
help: ## Show this help message
	@echo ""
	@echo "$(_SOPS_BOLD)Monitor Cluster SOPS Secret Management$(_SOPS_NC)"
	@echo "Environment: $(SOPS_ENV_NAME)"
	@echo ""
	@echo "$(_SOPS_BOLD)Quick Start:$(_SOPS_NC)"
	@echo "  1. make setup          # Generate all secrets"
	@echo ""
	@echo "$(_SOPS_BOLD)Secret Generation:$(_SOPS_NC)"
	@echo "  secret-loki-s3         Generate Loki S3 storage credentials secret"
	@echo "  setup                  Complete setup: generate all secrets"
	@echo ""
	@echo "$(_SOPS_BOLD)Note:$(_SOPS_NC)"
	@echo "  Uses dedicated loki S3 user from SeaweedFS credentials"
	@echo "  Credentials are automatically extracted from:"
	@echo "    $(SEAWEEDFS_SECRET_PATH)"
	@echo ""

# ============================================================================
# Secret Generation Targets
# ============================================================================

.PHONY: secret-loki-s3
secret-loki-s3: sops-check-deps sops-check-config ## Generate Loki S3 storage credentials secret (encrypted)
	@echo "$(_SOPS_BLUE)Generating Loki S3 storage credentials secret...$(_SOPS_NC)"
	@if [ ! -f "$(SEAWEEDFS_SECRET_PATH)" ]; then \
		echo "$(_SOPS_RED)Error: SeaweedFS credentials not found at $(SEAWEEDFS_SECRET_PATH)$(_SOPS_NC)"; \
		echo "Generate SeaweedFS credentials first:"; \
		echo "  cd ../../seaweedfs-cluster/shangkuei-lab && make secret-s3-credentials"; \
		exit 1; \
	fi
	@echo ""
	@echo "Extracting loki credentials from SeaweedFS secret..."
	@ACCESS_KEY=$$(SOPS_AGE_KEY_FILE="$(SOPS_AGE_KEY_FILE)" sops --config $(SOPS_CONFIG) -d $(SEAWEEDFS_SECRET_PATH) | grep 'loki_access_key_id:' | awk '{print $$2}'); \
	SECRET_KEY=$$(SOPS_AGE_KEY_FILE="$(SOPS_AGE_KEY_FILE)" sops --config $(SOPS_CONFIG) -d $(SEAWEEDFS_SECRET_PATH) | grep 'loki_secret_access_key:' | awk '{print $$2}'); \
	if [ -z "$$ACCESS_KEY" ] || [ -z "$$SECRET_KEY" ]; then \
		echo "$(_SOPS_RED)Error: Loki credentials not found in SeaweedFS secret$(_SOPS_NC)"; \
		echo "Regenerate SeaweedFS credentials with loki user:"; \
		echo "  cd ../../seaweedfs-cluster/shangkuei-lab && make secret-s3-credentials"; \
		exit 1; \
	fi; \
	echo ""; \
	echo "Loki S3 credentials:"; \
	echo "  Access Key ID: $$ACCESS_KEY"; \
	echo "  Secret Access Key: $$SECRET_KEY"; \
	echo ""; \
	echo "---" > $(LOKI_S3_ENC); \
	echo "# Loki S3 storage credentials secret (ENCRYPTED)" >> $(LOKI_S3_ENC); \
	echo "# Generated by: make secret-loki-s3" >> $(LOKI_S3_ENC); \
	echo "# Uses dedicated loki S3 user from SeaweedFS" >> $(LOKI_S3_ENC); \
	echo "apiVersion: v1" >> $(LOKI_S3_ENC); \
	echo "kind: Secret" >> $(LOKI_S3_ENC); \
	echo "metadata:" >> $(LOKI_S3_ENC); \
	echo "  name: loki-s3-credentials" >> $(LOKI_S3_ENC); \
	echo "  namespace: monitoring" >> $(LOKI_S3_ENC); \
	echo "type: Opaque" >> $(LOKI_S3_ENC); \
	echo "stringData:" >> $(LOKI_S3_ENC); \
	echo "  bucketnames: loki" >> $(LOKI_S3_ENC); \
	echo "  endpoint: http://seaweedfs-filer.seaweedfs.svc.cluster.local:8333" >> $(LOKI_S3_ENC); \
	echo "  access_key_id: $$ACCESS_KEY" >> $(LOKI_S3_ENC); \
	echo "  access_key_secret: $$SECRET_KEY" >> $(LOKI_S3_ENC); \
	echo "  region: us-east-1" >> $(LOKI_S3_ENC); \
	SOPS_AGE_KEY_FILE="$(SOPS_AGE_KEY_FILE)" sops --config $(SOPS_CONFIG) --input-type yaml --output-type yaml --encrypt --in-place $(LOKI_S3_ENC); \
	echo ""; \
	echo "$(_SOPS_GREEN)Generated: $(LOKI_S3_ENC)$(_SOPS_NC)"

.PHONY: setup
setup: secret-loki-s3 ## Complete setup: generate all secrets
	@echo ""
	@echo "$(_SOPS_GREEN)Setup complete!$(_SOPS_NC)"

# ============================================================================
# Cleanup
# ============================================================================

.PHONY: clean
clean: sops-clean ## Remove generated files (keeps encrypted files)
	@echo "$(_SOPS_GREEN)Cleanup complete$(_SOPS_NC)"

.PHONY: clean-all
clean-all: clean ## Remove all generated files including encrypted secrets
	@rm -f *.enc.yaml *.yaml.enc
	@echo "$(_SOPS_GREEN)All generated files removed$(_SOPS_NC)"
