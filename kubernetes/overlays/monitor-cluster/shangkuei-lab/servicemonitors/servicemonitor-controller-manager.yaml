---
# Kubernetes Controller Manager metrics scraping for Talos Linux
#
# Talos runs control plane components as containers (not K8s pods), so we need:
# 1. A headless Service pointing to the component
# 2. Manual Endpoints with control plane node IPs
# 3. A ServiceMonitor to configure Prometheus scraping
#
# Prerequisites:
# - Talos machine config must set controllerManager.extraArgs.bind-address = "0.0.0.0"
#   (configured in terraform.tfvars: additional_control_plane_patches)

apiVersion: v1
kind: Service
metadata:
  name: kube-controller-manager
  namespace: kube-system
  labels:
    app.kubernetes.io/name: kube-controller-manager
    k8s-app: kube-controller-manager
    app.kubernetes.io/part-of: kube-prometheus-stack
    app.kubernetes.io/managed-by: kustomize
spec:
  clusterIP: None
  ports:
    - name: https-metrics
      port: 10257
      targetPort: 10257
      protocol: TCP
  type: ClusterIP
---
apiVersion: v1
kind: Endpoints
metadata:
  name: kube-controller-manager
  namespace: kube-system
  labels:
    app.kubernetes.io/name: kube-controller-manager
    k8s-app: kube-controller-manager
    app.kubernetes.io/part-of: kube-prometheus-stack
    app.kubernetes.io/managed-by: kustomize
subsets:
  - addresses:
      # Control plane node Tailscale IP
      # Update this list if adding more control plane nodes
      - ip: 100.123.248.23
    ports:
      - name: https-metrics
        port: 10257
        protocol: TCP
---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: prometheus-kube-controller-manager
  namespace: monitoring
  labels:
    app.kubernetes.io/name: kube-controller-manager
    app.kubernetes.io/instance: prometheus-operator
    app.kubernetes.io/part-of: kube-prometheus-stack
    app.kubernetes.io/managed-by: kustomize
    prometheus.io/scrape-by: alloy
spec:
  jobLabel: app.kubernetes.io/name
  namespaceSelector:
    matchNames:
      - kube-system
  selector:
    matchLabels:
      app.kubernetes.io/name: kube-controller-manager
  endpoints:
    - port: https-metrics
      scheme: https
      bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token
      tlsConfig:
        # Controller manager uses self-signed certificates
        insecureSkipVerify: true
      relabelings:
        - action: replace
          replacement: shangkuei-lab
          targetLabel: cluster
      metricRelabelings:
        # Drop high-cardinality histogram buckets
        - action: drop
          regex: workqueue_queue_duration_seconds_bucket;(0.01|0.1|0.25|0.5|2|5|20|100)(\.0)?
          sourceLabels:
            - __name__
            - le
        - action: drop
          regex: workqueue_work_duration_seconds_bucket;(0.01|0.1|0.25|0.5|2|5|20|100)(\.0)?
          sourceLabels:
            - __name__
            - le
        # Drop go runtime metrics
        - action: drop
          regex: go_(gc|sched)_.*_bucket
          sourceLabels:
            - __name__
        - action: drop
          regex: go_godebug_.*
          sourceLabels:
            - __name__
