---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - ../../../base/openebs
  - storageclass-zfs.yaml
  - storageclass-mayastor.yaml
  - diskpools.yaml

labels:
  - pairs:
      app.kubernetes.io/instance: shangkuei-lab
      app.kubernetes.io/environment: lab

# Enable both Mayastor and ZFS LocalPV for shangkuei-lab cluster
# - worker-{1,2,3}: Mayastor (replicated NVMe storage) - labeled openebs.io/engine=mayastor
# - worker-4: ZFS LocalPV (local ZFS storage) - labeled openebs.io/zfs=true
#
# Node labels are managed by Terraform:
# - openebs.io/engine=mayastor: auto-added when openebs_storage=true
# - openebs.io/zfs=true: auto-added when zfs_pools is configured
patches:
  - patch: |-
      # LocalPV Hostpath Provisioner resources (VPA target: 15m/32Mi, limit increased for burst)
      - op: replace
        path: /spec/values/localpv-provisioner/localpv/resources
        value:
          limits:
            cpu: 200m
            memory: 128Mi
          requests:
            cpu: 25m
            memory: 32Mi
      - op: replace
        path: /spec/values/engines/local/zfs/enabled
        value: true
      - op: replace
        path: /spec/values/engines/replicated/mayastor/enabled
        value: true
      - op: replace
        path: /spec/values/ndm/enabled
        value: true
      - op: replace
        path: /spec/values/ndmOperator/enabled
        value: true
      # ZFS LocalPV Configuration (worker-4)
      # Note: StorageClass is created separately in storageclass-zfs.yaml
      # (the umbrella chart doesn't pass zfsClass values to the subchart)
      - op: add
        path: /spec/values/zfs-localpv
        value:
          enabled: true
          # Talos compatibility: use writable path for encryption keys
          zfsNode:
            encrKeysDir: "/var/openebs/encr-keys"
            nodeSelector:
              openebs.io/zfs: "true"
            # Resources based on VPA recommendations (target: 11m/16Mi)
            resources:
              limits:
                cpu: 100m
                memory: 128Mi
              requests:
                cpu: 25m
                memory: 32Mi
          zfsController:
            nodeSelector:
              openebs.io/zfs: "true"
            # Resources based on VPA recommendations (target: 11m/22Mi)
            resources:
              limits:
                cpu: 200m
                memory: 256Mi
              requests:
                cpu: 25m
                memory: 64Mi
      # Mayastor Configuration (worker-1,2,3)
      # Note: StorageClass and DiskPools are created separately
      # (the umbrella chart doesn't pass these values to the subchart)
      - op: add
        path: /spec/values/mayastor
        value:
          enabled: true
          # io-engine runs on labeled nodes with hugepages
          # Resources based on VPA (target: 2406m/35Mi) - CPU kept high for NVMe I/O
          io_engine:
            # Required for VMs (Proxmox/KVM/VMware/UTM) - fixes DPDK IOVA allocation
            envcontext: "iova-mode=pa"
            nodeSelector:
              openebs.io/engine: "mayastor"
            resources:
              limits:
                cpu: "2.5"
                memory: "512Mi"
                hugepages-2Mi: "2Gi"
              requests:
                cpu: "2"
                memory: "128Mi"
                hugepages-2Mi: "2Gi"
          # Agent components - resources based on VPA recommendations
          agents:
            core:
              # VPA target: 11m/16Mi
              resources:
                limits:
                  cpu: 500m
                  memory: 128Mi
                requests:
                  cpu: 50m
                  memory: 32Mi
            ha:
              node:
                # VPA target: 15m/32Mi
                resources:
                  limits:
                    cpu: 100m
                    memory: 64Mi
                  requests:
                    cpu: 25m
                    memory: 32Mi
          # REST API - resources based on VPA (target: 7m/16Mi)
          apis:
            rest:
              resources:
                limits:
                  cpu: 100m
                  memory: 64Mi
                requests:
                  cpu: 25m
                  memory: 32Mi
          # Control plane components
          csi:
            controller:
              # VPA target: 11m/11Mi
              resources:
                limits:
                  cpu: 100m
                  memory: 128Mi
                requests:
                  cpu: 25m
                  memory: 64Mi
            node:
              nodeSelector:
                openebs.io/engine: "mayastor"
              # VPA target: 11m/16Mi (limit increased for burst)
              resources:
                limits:
                  cpu: 200m
                  memory: 128Mi
                requests:
                  cpu: 25m
                  memory: 64Mi
          # Diskpool operator - VPA target: 15m/32Mi
          operators:
            pool:
              resources:
                limits:
                  cpu: 100m
                  memory: 64Mi
                requests:
                  cpu: 25m
                  memory: 32Mi
          # Observability callhome - VPA target: 11m/16Mi
          obs:
            callhome:
              resources:
                limits:
                  cpu: 100m
                  memory: 64Mi
                requests:
                  cpu: 25m
                  memory: 32Mi
          # etcd - resources based on VPA (target: 23m/35Mi)
          etcd:
            replicaCount: 3
            nodeSelector:
              openebs.io/engine: "mayastor"
            persistence:
              enabled: true
              size: 2Gi
            # LocalPV storage class for etcd - must match Terraform kubelet extraMount
            localpvScConfig:
              enabled: true
              basePath: "/var/openebs/local/etcd"
            resources:
              limits:
                cpu: 200m
                memory: 256Mi
              requests:
                cpu: 50m
                memory: 64Mi
          # NATS for Mayastor communication - VPA target: 11m/11Mi
          nats:
            replicaCount: 3
            nodeSelector:
              openebs.io/engine: "mayastor"
            nats:
              resources:
                limits:
                  cpu: 100m
                  memory: 64Mi
                requests:
                  cpu: 25m
                  memory: 32Mi
    target:
      kind: HelmRelease
      name: openebs
