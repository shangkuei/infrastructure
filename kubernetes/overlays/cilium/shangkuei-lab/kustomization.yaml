---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - ../../../base/cilium

labels:
  - pairs:
      app.kubernetes.io/instance: shangkuei-lab
      app.kubernetes.io/environment: lab

# shangkuei-lab cluster overlay for Cilium
# Adds cluster-specific resources and ServiceMonitor configuration
patches:
  - patch: |-
      # Cilium Agent resources based on VPA recommendations
      # VPA target: 323m CPU, 194Mi memory; upperBound: 3101m, 1865Mi
      - op: add
        path: /spec/values/resources
        value:
          requests:
            cpu: 300m
            memory: 256Mi
          limits:
            cpu: 2000m
            memory: 2Gi
      # Cilium Envoy resources based on VPA recommendations
      - op: add
        path: /spec/values/envoy/resources
        value:
          requests:
            cpu: 25m
            memory: 64Mi
          limits:
            cpu: 500m
            memory: 256Mi
      # Hubble Relay resources based on VPA recommendations
      - op: add
        path: /spec/values/hubble/relay/resources
        value:
          requests:
            cpu: 15m
            memory: 32Mi
          limits:
            cpu: 100m
            memory: 128Mi
      # Hubble Relay ServiceMonitor configuration
      - op: add
        path: /spec/values/hubble/relay/prometheus/serviceMonitor/labels
        value:
          prometheus.io/scrape-by: alloy
      - op: add
        path: /spec/values/hubble/relay/prometheus/serviceMonitor/relabelings
        value:
          - action: replace
            replacement: shangkuei-lab
            targetLabel: cluster
      # Hubble UI Frontend resources
      - op: add
        path: /spec/values/hubble/ui/frontend/resources
        value:
          requests:
            cpu: 15m
            memory: 32Mi
          limits:
            cpu: 100m
            memory: 64Mi
      # Hubble UI Backend resources
      - op: add
        path: /spec/values/hubble/ui/backend/resources
        value:
          requests:
            cpu: 15m
            memory: 32Mi
          limits:
            cpu: 100m
            memory: 64Mi
      # Hubble Metrics ServiceMonitor configuration
      - op: add
        path: /spec/values/hubble/metrics/serviceMonitor/labels
        value:
          prometheus.io/scrape-by: alloy
      - op: add
        path: /spec/values/hubble/metrics/serviceMonitor/relabelings
        value:
          - action: replace
            replacement: shangkuei-lab
            targetLabel: cluster
      # Operator resources based on VPA recommendations
      - op: add
        path: /spec/values/operator/resources
        value:
          requests:
            cpu: 50m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 256Mi
      # Operator ServiceMonitor configuration
      - op: add
        path: /spec/values/operator/prometheus/serviceMonitor/labels
        value:
          prometheus.io/scrape-by: alloy
      - op: add
        path: /spec/values/operator/prometheus/serviceMonitor/relabelings
        value:
          - action: replace
            replacement: shangkuei-lab
            targetLabel: cluster
      # Agent ServiceMonitor configuration
      - op: add
        path: /spec/values/prometheus/serviceMonitor/labels
        value:
          prometheus.io/scrape-by: alloy
      - op: add
        path: /spec/values/prometheus/serviceMonitor/relabelings
        value:
          - action: replace
            replacement: shangkuei-lab
            targetLabel: cluster
    target:
      kind: HelmRelease
      name: cilium
