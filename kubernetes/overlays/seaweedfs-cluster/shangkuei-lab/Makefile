# ============================================================================
# Makefile - SeaweedFS Operator SOPS Secret Management (shangkuei-lab)
# ============================================================================
# Generates SOPS-encrypted Kubernetes secrets for SeaweedFS S3 storage
#
# Usage:
#   make help                       # Show all targets
#   make secret-s3-credentials      # Generate S3 credentials secret
#   make setup                      # Generate all secrets
#   make sops-validate              # Validate encrypted files
# ============================================================================

# Configuration
SOPS_DOMAIN := kubernetes
SOPS_ENV_NAME := gitops-shangkuei-lab-flux
SOPS_KEY_STRATEGY := central

# Encrypted file variables
S3_CREDENTIALS_ENC := secret-seaweedfs-s3-credentials.enc.yaml

# Include shared SOPS operations
include ../../../../makefiles/sops.mk

# ============================================================================
# Default Target
# ============================================================================

.PHONY: help
help: ## Show this help message
	@echo ""
	@echo "$(_SOPS_BOLD)SeaweedFS Operator SOPS Secret Management$(_SOPS_NC)"
	@echo "Environment: $(SOPS_ENV_NAME)"
	@echo "Strategy: $(SOPS_KEY_STRATEGY) | Key: $(SOPS_AGE_KEY_FILE)"
	@echo ""
	@echo "$(_SOPS_BOLD)Quick Start:$(_SOPS_NC)"
	@echo "  1. make setup          # Generate all secrets"
	@echo ""
	@echo "$(_SOPS_BOLD)Secret Generation:$(_SOPS_NC)"
	@echo "  secret-s3-credentials  Generate SeaweedFS S3 credentials secret"
	@echo "  setup                  Complete setup: generate all secrets"
	@echo ""
	@echo "$(_SOPS_BOLD)Users:$(_SOPS_NC)"
	@echo "  admin                  Full admin access (Admin, Read, Write, List, Tagging)"
	@echo "  loki                   Bucket-specific access for Loki (Read:loki, Write:loki, List:loki)"
	@echo ""
	@echo "$(_SOPS_BOLD)SOPS Operations:$(_SOPS_NC)"
	@echo "  sops-validate          Validate all encrypted files"
	@echo "  sops-decrypt FILE=x    Decrypt file to stdout"
	@echo "  sops-edit FILE=x       Edit encrypted file"
	@echo "  sops-info              Display encryption configuration"
	@echo "  sops-clean             Remove decrypted/temporary files"
	@echo ""
	@echo "$(_SOPS_BOLD)Maintenance:$(_SOPS_NC)"
	@echo "  clean                  Remove temporary files (keeps .enc.yaml)"
	@echo "  clean-all              Remove all generated files"
	@echo ""

# ============================================================================
# Secret Generation Targets
# ============================================================================

.PHONY: secret-s3-credentials
secret-s3-credentials: sops-check-deps sops-check-config ## Generate SeaweedFS S3 credentials secret (encrypted)
	@echo "$(_SOPS_BLUE)Generating SeaweedFS S3 credentials secret...$(_SOPS_NC)"
	@if [ ! -f "$(SOPS_AGE_KEY_FILE)" ]; then \
		echo "$(_SOPS_RED)Error: $(SOPS_AGE_KEY_FILE) not found$(_SOPS_NC)"; \
		echo "Generate the flux key first:"; \
		echo "  cd terraform/environments/gitops-shangkuei-lab && make flux-keygen"; \
		exit 1; \
	fi
	@ADMIN_ACCESS_KEY=$$(openssl rand -hex 16); \
	ADMIN_SECRET_KEY=$$(openssl rand -base64 32 | tr -d '/+=' | head -c 32); \
	LOKI_ACCESS_KEY=$$(openssl rand -hex 16); \
	LOKI_SECRET_KEY=$$(openssl rand -base64 32 | tr -d '/+=' | head -c 32); \
	echo ""; \
	echo "Generated S3 credentials:"; \
	echo ""; \
	echo "  Admin User:"; \
	echo "    Access Key ID: $$ADMIN_ACCESS_KEY"; \
	echo "    Secret Access Key: $$ADMIN_SECRET_KEY"; \
	echo ""; \
	echo "  Loki User:"; \
	echo "    Access Key ID: $$LOKI_ACCESS_KEY"; \
	echo "    Secret Access Key: $$LOKI_SECRET_KEY"; \
	echo ""; \
	echo "(Save these credentials securely - they cannot be recovered)"; \
	echo ""; \
	echo "---" > $(S3_CREDENTIALS_ENC); \
	echo "# SeaweedFS S3 credentials secret (ENCRYPTED)" >> $(S3_CREDENTIALS_ENC); \
	echo "# Generated by: make secret-s3-credentials" >> $(S3_CREDENTIALS_ENC); \
	echo "# Contains S3 identities JSON config and individual user credentials" >> $(S3_CREDENTIALS_ENC); \
	echo "#" >> $(S3_CREDENTIALS_ENC); \
	echo "# Users:" >> $(S3_CREDENTIALS_ENC); \
	echo "#   - admin: Full admin access (Admin, Read, Write, List, Tagging)" >> $(S3_CREDENTIALS_ENC); \
	echo "#   - loki: Bucket-specific access for Loki (Read:loki, Write:loki, List:loki)" >> $(S3_CREDENTIALS_ENC); \
	echo "apiVersion: v1" >> $(S3_CREDENTIALS_ENC); \
	echo "kind: Secret" >> $(S3_CREDENTIALS_ENC); \
	echo "metadata:" >> $(S3_CREDENTIALS_ENC); \
	echo "  name: seaweedfs-s3-credentials" >> $(S3_CREDENTIALS_ENC); \
	echo "  namespace: seaweedfs" >> $(S3_CREDENTIALS_ENC); \
	echo "type: Opaque" >> $(S3_CREDENTIALS_ENC); \
	echo "stringData:" >> $(S3_CREDENTIALS_ENC); \
	echo "  # S3 identities JSON configuration (referenced by SeaweedFS filer)" >> $(S3_CREDENTIALS_ENC); \
	echo "  config.json: |" >> $(S3_CREDENTIALS_ENC); \
	echo "    {" >> $(S3_CREDENTIALS_ENC); \
	echo "      \"identities\": [" >> $(S3_CREDENTIALS_ENC); \
	echo "        {" >> $(S3_CREDENTIALS_ENC); \
	echo "          \"name\": \"admin\"," >> $(S3_CREDENTIALS_ENC); \
	echo "          \"credentials\": [{\"accessKey\": \"$$ADMIN_ACCESS_KEY\", \"secretKey\": \"$$ADMIN_SECRET_KEY\"}]," >> $(S3_CREDENTIALS_ENC); \
	echo "          \"actions\": [\"Admin\", \"Read\", \"Write\", \"List\", \"Tagging\"]" >> $(S3_CREDENTIALS_ENC); \
	echo "        }," >> $(S3_CREDENTIALS_ENC); \
	echo "        {" >> $(S3_CREDENTIALS_ENC); \
	echo "          \"name\": \"loki\"," >> $(S3_CREDENTIALS_ENC); \
	echo "          \"credentials\": [{\"accessKey\": \"$$LOKI_ACCESS_KEY\", \"secretKey\": \"$$LOKI_SECRET_KEY\"}]," >> $(S3_CREDENTIALS_ENC); \
	echo "          \"actions\": [\"Read:loki\", \"Write:loki\", \"List:loki\"]" >> $(S3_CREDENTIALS_ENC); \
	echo "        }" >> $(S3_CREDENTIALS_ENC); \
	echo "      ]" >> $(S3_CREDENTIALS_ENC); \
	echo "    }" >> $(S3_CREDENTIALS_ENC); \
	echo "  # Individual credentials for external reference" >> $(S3_CREDENTIALS_ENC); \
	echo "  admin_access_key_id: $$ADMIN_ACCESS_KEY" >> $(S3_CREDENTIALS_ENC); \
	echo "  admin_secret_access_key: $$ADMIN_SECRET_KEY" >> $(S3_CREDENTIALS_ENC); \
	echo "  loki_access_key_id: $$LOKI_ACCESS_KEY" >> $(S3_CREDENTIALS_ENC); \
	echo "  loki_secret_access_key: $$LOKI_SECRET_KEY" >> $(S3_CREDENTIALS_ENC); \
	SOPS_AGE_KEY_FILE="$(SOPS_AGE_KEY_FILE)" sops --config $(SOPS_CONFIG) --input-type yaml --output-type yaml --encrypt --in-place $(S3_CREDENTIALS_ENC); \
	echo ""; \
	echo "$(_SOPS_GREEN)Generated: $(S3_CREDENTIALS_ENC)$(_SOPS_NC)"
	@echo ""
	@echo "Next steps:"
	@echo "  1. Review: make sops-decrypt FILE=$(S3_CREDENTIALS_ENC)"
	@echo "  2. Commit to git"

.PHONY: setup
setup: secret-s3-credentials ## Complete setup: generate all secrets
	@echo ""
	@echo "$(_SOPS_GREEN)Setup complete!$(_SOPS_NC)"
	@echo ""
	@echo "Generated files:"
	@ls -1 *.enc.yaml 2>/dev/null || echo "  (no encrypted files)"
	@echo ""
	@echo "Next steps:"
	@echo "  1. git add *.enc.yaml"
	@echo "  2. git commit -m 'feat(seaweedfs): add SOPS secrets for shangkuei-lab'"
	@echo "  3. git push"

# ============================================================================
# Cleanup
# ============================================================================

.PHONY: clean
clean: sops-clean ## Remove generated files (keeps encrypted files)
	@rm -f secret-seaweedfs-s3-credentials.yaml
	@echo "$(_SOPS_GREEN)Cleanup complete$(_SOPS_NC)"
	@echo "Encrypted files preserved"

.PHONY: clean-all
clean-all: clean ## Remove all generated files including encrypted secrets
	@echo "$(_SOPS_YELLOW)Removing all generated files...$(_SOPS_NC)"
	@rm -f *.enc.yaml *.yaml.enc
	@echo "$(_SOPS_GREEN)All generated files removed$(_SOPS_NC)"

# ============================================================================
# Backward Compatibility Aliases
# ============================================================================

.PHONY: check-deps check-sops-config validate
check-deps: sops-check-deps ## Alias for sops-check-deps
	@:
check-sops-config: sops-check-config ## Alias for sops-check-config
	@:
validate: sops-validate ## Alias for sops-validate
	@:
