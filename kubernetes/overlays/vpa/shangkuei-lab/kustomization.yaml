---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - ../../../base/vpa

labels:
  - pairs:
      app.kubernetes.io/instance: shangkuei-lab
      app.kubernetes.io/environment: lab

patches:
  - patch: |-
      # Recommender resources and Prometheus integration
      - op: add
        path: /spec/values/recommender/resources
        value:
          requests:
            cpu: 50m
            memory: 500Mi
          limits:
            memory: 1Gi
      - op: add
        path: /spec/values/recommender/extraArgs
        value:
          pod-recommendation-min-cpu-millicores: "15"
          pod-recommendation-min-memory-mb: "32"
          # Prometheus integration for historical metrics
          storage: "prometheus"
          prometheus-address: "http://prometheus-operated.monitoring.svc:9090"
          prometheus-cadvisor-job-name: "kubelet"
          history-length: "48h"
          # Label mapping for modern Prometheus metrics
          container-pod-name-label: "pod"
          container-name-label: "container"
          metric-for-pod-labels: "kube_pod_info{job=\"kube-state-metrics\"}[48h]"
          pod-name-label: "pod"
          pod-namespace-label: "namespace"
      # Admission Controller resources
      - op: add
        path: /spec/values/admissionController/resources
        value:
          requests:
            cpu: 50m
            memory: 200Mi
          limits:
            memory: 256Mi
      # ServiceMonitor configuration
      - op: add
        path: /spec/values/metrics/serviceMonitor/additionalLabels
        value:
          prometheus.io/scrape-by: alloy
      - op: add
        path: /spec/values/metrics/serviceMonitor/relabelings
        value:
          - action: replace
            targetLabel: cluster
            replacement: shangkuei-lab
    target:
      kind: HelmRelease
      name: vpa
