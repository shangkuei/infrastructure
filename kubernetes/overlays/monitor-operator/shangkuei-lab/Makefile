# ============================================================================
# Makefile - Monitor Operator SOPS Secret Management (shangkuei-lab)
# ============================================================================
# Generates SOPS-encrypted Kubernetes secrets for monitoring stack
#
# Usage:
#   make help                    # Show all targets
#   make secret-loki-s3          # Generate Loki S3 secret
#   make setup                   # Generate all secrets
#   make sops-validate           # Validate encrypted files
#
# Note: Grafana admin credentials are auto-generated by grafana-operator
#       in secret: grafana-cluster-admin-credentials
# ============================================================================

# Configuration
SOPS_DOMAIN := kubernetes
SOPS_ENV_NAME := gitops-shangkuei-lab-flux
SOPS_KEY_STRATEGY := central

# Encrypted file variables
LOKI_S3_ENC := secret-loki-s3.enc.yaml

# Include shared SOPS operations
include ../../../../makefiles/sops.mk

# ============================================================================
# Default Target
# ============================================================================

.PHONY: help
help: ## Show this help message
	@echo ""
	@echo "$(_SOPS_BOLD)Monitor Operator SOPS Secret Management$(_SOPS_NC)"
	@echo "Environment: $(SOPS_ENV_NAME)"
	@echo "Strategy: $(SOPS_KEY_STRATEGY) | Key: $(SOPS_AGE_KEY_FILE)"
	@echo ""
	@echo "$(_SOPS_BOLD)Quick Start:$(_SOPS_NC)"
	@echo "  1. make setup          # Generate all secrets"
	@echo ""
	@echo "$(_SOPS_BOLD)Secret Generation:$(_SOPS_NC)"
	@echo "  secret-loki-s3         Generate Loki S3 credentials secret"
	@echo "  setup                  Complete setup: generate all secrets"
	@echo ""
	@echo "$(_SOPS_BOLD)SOPS Operations:$(_SOPS_NC)"
	@echo "  sops-validate          Validate all encrypted files"
	@echo "  sops-decrypt FILE=x    Decrypt file to stdout"
	@echo "  sops-edit FILE=x       Edit encrypted file"
	@echo "  sops-info              Display encryption configuration"
	@echo "  sops-clean             Remove decrypted/temporary files"
	@echo ""
	@echo "$(_SOPS_BOLD)Maintenance:$(_SOPS_NC)"
	@echo "  clean                  Remove temporary files (keeps .enc.yaml)"
	@echo "  clean-all              Remove all generated files"
	@echo ""
	@echo "$(_SOPS_BOLD)Note:$(_SOPS_NC)"
	@echo "  Grafana admin credentials are auto-generated by grafana-operator"
	@echo "  Secret: grafana-cluster-admin-credentials"
	@echo ""

# ============================================================================
# Secret Generation Targets
# ============================================================================

.PHONY: secret-loki-s3
secret-loki-s3: sops-check-deps sops-check-config ## Generate Loki S3 credentials secret (encrypted)
	@echo "$(_SOPS_BLUE)Generating Loki S3 credentials secret...$(_SOPS_NC)"
	@if [ ! -f "$(SOPS_AGE_KEY_FILE)" ]; then \
		echo "$(_SOPS_RED)Error: $(SOPS_AGE_KEY_FILE) not found$(_SOPS_NC)"; \
		echo "Generate the flux key first:"; \
		echo "  cd terraform/environments/gitops-shangkuei-lab && make flux-keygen"; \
		exit 1; \
	fi
	@read -p "S3 Access Key ID: " ACCESS_KEY; \
	read -p "S3 Secret Access Key: " SECRET_KEY; \
	echo ""; \
	echo "---" > $(LOKI_S3_ENC); \
	echo "# Loki S3 credentials secret (ENCRYPTED)" >> $(LOKI_S3_ENC); \
	echo "# Generated by: make secret-loki-s3" >> $(LOKI_S3_ENC); \
	echo "# Only stringData section is encrypted" >> $(LOKI_S3_ENC); \
	echo "apiVersion: v1" >> $(LOKI_S3_ENC); \
	echo "kind: Secret" >> $(LOKI_S3_ENC); \
	echo "metadata:" >> $(LOKI_S3_ENC); \
	echo "  name: loki-s3-credentials" >> $(LOKI_S3_ENC); \
	echo "  namespace: monitoring" >> $(LOKI_S3_ENC); \
	echo "type: Opaque" >> $(LOKI_S3_ENC); \
	echo "stringData:" >> $(LOKI_S3_ENC); \
	echo "  access_key_id: $$ACCESS_KEY" >> $(LOKI_S3_ENC); \
	echo "  access_key_secret: $$SECRET_KEY" >> $(LOKI_S3_ENC); \
	SOPS_AGE_KEY_FILE="$(SOPS_AGE_KEY_FILE)" sops --config $(SOPS_CONFIG) --input-type yaml --output-type yaml --encrypt --in-place $(LOKI_S3_ENC); \
	echo ""; \
	echo "$(_SOPS_GREEN)Generated: $(LOKI_S3_ENC)$(_SOPS_NC)"
	@echo ""
	@echo "Next steps:"
	@echo "  1. Review: make sops-decrypt FILE=$(LOKI_S3_ENC)"
	@echo "  2. Commit to git"

.PHONY: setup
setup: secret-loki-s3 ## Complete setup: generate all secrets
	@echo ""
	@echo "$(_SOPS_GREEN)Setup complete!$(_SOPS_NC)"
	@echo ""
	@echo "Generated files:"
	@ls -1 *.enc.yaml 2>/dev/null || echo "  (no encrypted files)"
	@echo ""
	@echo "Next steps:"
	@echo "  1. git add *.enc.yaml"
	@echo "  2. git commit -m 'feat(monitoring): add SOPS secrets for shangkuei-lab'"
	@echo "  3. git push"

# ============================================================================
# Cleanup
# ============================================================================

.PHONY: clean
clean: sops-clean ## Remove generated files (keeps encrypted files)
	@echo "$(_SOPS_GREEN)Cleanup complete$(_SOPS_NC)"
	@echo "Encrypted files preserved"

.PHONY: clean-all
clean-all: clean ## Remove all generated files including encrypted secrets
	@echo "$(_SOPS_YELLOW)Removing all generated files...$(_SOPS_NC)"
	@rm -f *.enc.yaml *.yaml.enc
	@echo "$(_SOPS_GREEN)All generated files removed$(_SOPS_NC)"

# ============================================================================
# Backward Compatibility Aliases
# ============================================================================

.PHONY: check-deps check-sops-config validate
check-deps: sops-check-deps ## Alias for sops-check-deps
	@:
check-sops-config: sops-check-config ## Alias for sops-check-config
	@:
validate: sops-validate ## Alias for sops-validate
	@:
