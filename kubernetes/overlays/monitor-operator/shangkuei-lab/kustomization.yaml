---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - ../../../base/monitor-operator

labels:
  - pairs:
      app.kubernetes.io/instance: shangkuei-lab
      app.kubernetes.io/environment: lab

# shangkuei-lab cluster overlay for Prometheus and Grafana operators
# These are CRD providers - actual instances are deployed via monitor-cluster
patches:
  # Pin to 80.12.1 to test if 80.13.0 has metric_relabel_configs regression
  - patch: |-
      - op: replace
        path: /spec/chart/spec/version
        value: "80.12.1"
    target:
      kind: HelmRelease
      name: prometheus-operator
  - patch: |-
      # Note: Prometheus and Alertmanager configurations moved to explicit CRs
      # in monitor-cluster overlay for full GitOps control

      # Prometheus Operator resources (actual usage: 2m/21Mi)
      - op: replace
        path: /spec/values/prometheusOperator/resources
        value:
          requests:
            cpu: 25m
            memory: 64Mi
          limits:
            cpu: 200m
            memory: 256Mi
    target:
      kind: HelmRelease
      name: prometheus-operator

  # Grafana Operator configuration
  # Note: grafana-operator Helm chart uses 'additionalLabels' not 'labels'
  - patch: |-
      # Resources (actual usage: 2m/25Mi)
      - op: replace
        path: /spec/values/resources
        value:
          requests:
            cpu: 25m
            memory: 64Mi
          limits:
            cpu: 200m
            memory: 256Mi
      - op: add
        path: /spec/values/serviceMonitor/additionalLabels
        value:
          prometheus.io/scrape-by: alloy
      - op: add
        path: /spec/values/serviceMonitor/relabelings
        value:
          - targetLabel: cluster
            replacement: shangkuei-lab
    target:
      kind: HelmRelease
      name: grafana-operator
