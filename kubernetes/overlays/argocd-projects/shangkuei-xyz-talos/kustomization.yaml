---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - ../../../base/argocd
  # ArgoCD Projects (AppProject only, Applications selected below)
  - ../../../base/argocd-projects/argocd-examples
  - ../../../base/argocd-projects/edatw
  # ArgoCD Applications for this cluster (KSOPS example)
  - ../../../base/argocd-projects/argocd-examples/apps-ksops
  # Cluster-specific resources
  - secret-sops-age.enc.yaml

labels:
  - pairs:
      app.kubernetes.io/instance: shangkuei-xyz-talos
      app.kubernetes.io/environment: production

# Patch HelmRelease to mount the SOPS Age key and configure KSOPS
patches:
  - patch: |-
      - op: add
        path: /spec/values/repoServer/env
        value:
          - name: SOPS_AGE_KEY_FILE
            value: /home/argocd/.config/sops/age/keys.txt
      - op: add
        path: /spec/values/repoServer/volumes/-
        value:
          name: sops-age
          secret:
            secretName: sops-age
      - op: add
        path: /spec/values/repoServer/volumeMounts/-
        value:
          name: sops-age
          mountPath: /home/argocd/.config/sops/age
          readOnly: true
    target:
      kind: HelmRelease
      name: argocd
  # Patch app-example to use cluster-specific overlay with KSOPS
  - patch: |-
      - op: replace
        path: /spec/source/path
        value: argocd/app-example/overlays/shangkuei-xyz-talos
    target:
      kind: Application
      name: app-example
  # Patch edatw application paths (from github.com/edatw/infrastructure)
  - patch: |-
      - op: replace
        path: /spec/source/path
        value: argocd/edatw-cloudflared/overlays/shangkuei-xyz-talos
    target:
      kind: Application
      name: edatw-cloudflared
  - patch: |-
      - op: replace
        path: /spec/source/path
        value: argocd/edatw-ed8/overlays/shangkuei-xyz-talos
    target:
      kind: Application
      name: edatw-ed8
  - patch: |-
      - op: replace
        path: /spec/source/path
        value: argocd/edatw-salary-mailman/overlays/shangkuei-xyz-talos
    target:
      kind: Application
      name: edatw-salary-mailman
