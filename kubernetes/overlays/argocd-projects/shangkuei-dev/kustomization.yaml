---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - ../../../base/argocd
  # ArgoCD Projects (AppProject only, Applications selected below)
  - ../../../base/argocd-projects/argocd-examples
  # ArgoCD Applications for this cluster (storage examples)
  - ../../../base/argocd-projects/argocd-examples/apps-storage
  # Cluster-specific resources
  - secret-sops-age.enc.yaml

labels:
  - pairs:
      app.kubernetes.io/instance: shangkuei-dev
      app.kubernetes.io/environment: development

# Patch HelmRelease to mount the SOPS Age key and configure KSOPS
patches:
  - patch: |-
      - op: add
        path: /spec/values/repoServer/env
        value:
          - name: SOPS_AGE_KEY_FILE
            value: /home/argocd/.config/sops/age/keys.txt
      - op: add
        path: /spec/values/repoServer/volumes/-
        value:
          name: sops-age
          secret:
            secretName: sops-age
      - op: add
        path: /spec/values/repoServer/volumeMounts/-
        value:
          name: sops-age
          mountPath: /home/argocd/.config/sops/age
          readOnly: true
    target:
      kind: HelmRelease
      name: argocd
  # Patch storage-example to use cluster-specific overlay (no Mayastor)
  - patch: |-
      - op: replace
        path: /spec/source/path
        value: argocd/storage-example/overlays/shangkuei-dev
    target:
      kind: Application
      name: storage-example
  # Patch snapshot-example to use cluster-specific overlay (no Mayastor)
  - patch: |-
      - op: replace
        path: /spec/source/path
        value: argocd/snapshot-example/overlays/shangkuei-dev
    target:
      kind: Application
      name: snapshot-example
