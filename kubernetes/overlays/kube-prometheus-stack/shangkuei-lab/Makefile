# ============================================================================
# Makefile - kube-prometheus-stack SOPS Secret Management (shangkuei-lab)
# ============================================================================
# Generates SOPS-encrypted Kubernetes secrets for monitoring stack
#
# Usage:
#   make help                    # Show all targets
#   make secret-grafana-admin    # Generate Grafana admin secret
#   make setup                   # Generate all secrets
#   make sops-validate           # Validate encrypted files
# ============================================================================

# Configuration
SOPS_DOMAIN := kubernetes
SOPS_ENV_NAME := gitops-shangkuei-lab-flux
SOPS_KEY_STRATEGY := central

# Encrypted file variables
GRAFANA_ADMIN_ENC := secret-grafana-admin.enc.yaml

# Include shared SOPS operations
include ../../../../makefiles/sops.mk

# ============================================================================
# Default Target
# ============================================================================

.PHONY: help
help: ## Show this help message
	@echo ""
	@echo "$(_SOPS_BOLD)kube-prometheus-stack SOPS Secret Management$(_SOPS_NC)"
	@echo "Environment: $(SOPS_ENV_NAME)"
	@echo "Strategy: $(SOPS_KEY_STRATEGY) | Key: $(SOPS_AGE_KEY_FILE)"
	@echo ""
	@echo "$(_SOPS_BOLD)Quick Start:$(_SOPS_NC)"
	@echo "  1. make setup          # Generate all secrets"
	@echo ""
	@echo "$(_SOPS_BOLD)Secret Generation:$(_SOPS_NC)"
	@echo "  secret-grafana-admin   Generate Grafana admin credentials secret"
	@echo "  setup                  Complete setup: generate all secrets"
	@echo ""
	@echo "$(_SOPS_BOLD)SOPS Operations:$(_SOPS_NC)"
	@echo "  sops-validate          Validate all encrypted files"
	@echo "  sops-decrypt FILE=x    Decrypt file to stdout"
	@echo "  sops-edit FILE=x       Edit encrypted file"
	@echo "  sops-info              Display encryption configuration"
	@echo "  sops-clean             Remove decrypted/temporary files"
	@echo ""
	@echo "$(_SOPS_BOLD)Maintenance:$(_SOPS_NC)"
	@echo "  clean                  Remove temporary files (keeps .enc.yaml)"
	@echo "  clean-all              Remove all generated files"
	@echo ""

# ============================================================================
# Secret Generation Targets
# ============================================================================

.PHONY: secret-grafana-admin
secret-grafana-admin: sops-check-deps sops-check-config ## Generate Grafana admin credentials secret (encrypted)
	@echo "$(_SOPS_BLUE)Generating Grafana admin credentials secret...$(_SOPS_NC)"
	@if [ ! -f "$(SOPS_AGE_KEY_FILE)" ]; then \
		echo "$(_SOPS_RED)Error: $(SOPS_AGE_KEY_FILE) not found$(_SOPS_NC)"; \
		echo "Generate the flux key first:"; \
		echo "  cd terraform/environments/gitops-shangkuei-lab && make flux-keygen"; \
		exit 1; \
	fi
	@read -p "Grafana Admin Username [admin]: " GRAFANA_USER; \
	GRAFANA_USER=$${GRAFANA_USER:-admin}; \
	GRAFANA_PASS=$$(openssl rand -base64 24 | tr -d '/+=' | head -c 24); \
	echo ""; \
	echo "Generated password: $$GRAFANA_PASS"; \
	echo "(Save this password securely - it cannot be recovered)"; \
	echo ""; \
	echo "---" > $(GRAFANA_ADMIN_ENC); \
	echo "# Grafana admin credentials secret (ENCRYPTED)" >> $(GRAFANA_ADMIN_ENC); \
	echo "# Generated by: make secret-grafana-admin" >> $(GRAFANA_ADMIN_ENC); \
	echo "# Only stringData section is encrypted" >> $(GRAFANA_ADMIN_ENC); \
	echo "apiVersion: v1" >> $(GRAFANA_ADMIN_ENC); \
	echo "kind: Secret" >> $(GRAFANA_ADMIN_ENC); \
	echo "metadata:" >> $(GRAFANA_ADMIN_ENC); \
	echo "  name: grafana-admin" >> $(GRAFANA_ADMIN_ENC); \
	echo "  namespace: monitoring" >> $(GRAFANA_ADMIN_ENC); \
	echo "type: Opaque" >> $(GRAFANA_ADMIN_ENC); \
	echo "stringData:" >> $(GRAFANA_ADMIN_ENC); \
	echo "  admin-user: $$GRAFANA_USER" >> $(GRAFANA_ADMIN_ENC); \
	echo "  admin-password: $$GRAFANA_PASS" >> $(GRAFANA_ADMIN_ENC); \
	SOPS_AGE_KEY_FILE="$(SOPS_AGE_KEY_FILE)" sops --config $(SOPS_CONFIG) --input-type yaml --output-type yaml --encrypt --in-place $(GRAFANA_ADMIN_ENC); \
	echo ""; \
	echo "$(_SOPS_GREEN)Generated: $(GRAFANA_ADMIN_ENC)$(_SOPS_NC)"
	@echo ""
	@echo "Next steps:"
	@echo "  1. Review: make sops-decrypt FILE=$(GRAFANA_ADMIN_ENC)"
	@echo "  2. Commit to git"

.PHONY: setup
setup: secret-grafana-admin ## Complete setup: generate all secrets
	@echo ""
	@echo "$(_SOPS_GREEN)Setup complete!$(_SOPS_NC)"
	@echo ""
	@echo "Generated files:"
	@ls -1 *.enc.yaml 2>/dev/null || echo "  (no encrypted files)"
	@echo ""
	@echo "Next steps:"
	@echo "  1. git add *.enc.yaml"
	@echo "  2. git commit -m 'feat(monitoring): add SOPS secrets for shangkuei-lab'"
	@echo "  3. git push"

# ============================================================================
# Cleanup
# ============================================================================

.PHONY: clean
clean: sops-clean ## Remove generated files (keeps encrypted files)
	@rm -f secret-grafana-admin.yaml
	@echo "$(_SOPS_GREEN)Cleanup complete$(_SOPS_NC)"
	@echo "Encrypted files preserved"

.PHONY: clean-all
clean-all: clean ## Remove all generated files including encrypted secrets
	@echo "$(_SOPS_YELLOW)Removing all generated files...$(_SOPS_NC)"
	@rm -f *.enc.yaml *.yaml.enc
	@echo "$(_SOPS_GREEN)All generated files removed$(_SOPS_NC)"

# ============================================================================
# Backward Compatibility Aliases
# ============================================================================

.PHONY: check-deps check-sops-config validate
check-deps: sops-check-deps ## Alias for sops-check-deps
	@:
check-sops-config: sops-check-config ## Alias for sops-check-config
	@:
validate: sops-validate ## Alias for sops-validate
	@:
