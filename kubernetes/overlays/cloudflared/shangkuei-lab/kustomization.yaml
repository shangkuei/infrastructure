---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - ../../../base/cloudflared
  # SOPS-encrypted secret for Cloudflare Tunnel credentials
  # Secret name: cloudflared (matches cloudflare.secretName in HelmRelease)
  - secret-tunnel-credentials.enc.yaml

patches:
  - target:
      kind: HelmRelease
      name: cloudflared
    patch: |
      - op: add
        path: /spec/values/cloudflare/tunnelName
        value: "shangkuei-lab"
      # Use postRenderers to patch ConfigMap with protocol setting
      # (Helm chart doesn't expose protocol as a value)
      - op: add
        path: /spec/postRenderers
        value:
          - kustomize:
              patches:
                - target:
                    kind: ConfigMap
                    name: cloudflared
                  patch: |
                    - op: replace
                      path: /data/config.yaml
                      value: |
                        tunnel: shangkuei-lab
                        credentials-file: /etc/cloudflared/creds/credentials.json
                        protocol: http2
                        warp-routing:
                          enabled: false
                        metrics: 0.0.0.0:2000
                        no-autoupdate: true
                # Add named port for metrics scraping (PodMonitor requires named ports)
                - target:
                    kind: Deployment
                    name: cloudflared
                  patch: |
                    - op: add
                      path: /spec/template/spec/containers/0/ports
                      value:
                        - name: metrics
                          containerPort: 2000
                          protocol: TCP

labels:
  - pairs:
      app.kubernetes.io/instance: shangkuei-lab
      app.kubernetes.io/environment: lab
