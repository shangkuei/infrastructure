# Unified SOPS Operations Specification

**Version**: 1.0
**Status**: Draft
**Last Updated**: 2025-12-02
**Owner**: Infrastructure Team

## Overview

This specification defines a unified SOPS (Secrets OPerationS) operations framework that standardizes secret management
across all domains in the infrastructure repository: **Terraform**, **Kubernetes**, and **Docker**.

### Problem Statement

Current SOPS implementation has grown organically, resulting in:

1. **Inconsistent target names** across domains (e.g., `encrypt-backend` vs `encrypt` vs `encrypt-all`)
2. **Different key management approaches** (static vs dynamic `.sops.yaml` generation)
3. **Varying validation capabilities** (some have `validate`, others don't)
4. **No shared code** between Makefiles (duplication of ~200 lines per environment)
5. **Different encryption scopes** (full file vs selective `encrypted_regex`)
6. **Inconsistent user experience** when switching between domains

### Goals

1. **Unified CLI Experience**: Same `make` targets work across all domains
2. **DRY Principle**: Shared `sops.mk` include file eliminates duplication
3. **Consistent Key Management**: Standardized workflow for key generation and import
4. **Domain Flexibility**: Allow domain-specific customization while maintaining consistency
5. **Backward Compatibility**: Existing workflows continue to work during migration

## Current State Analysis

### Domain Comparison Matrix

| Aspect | Terraform | Kubernetes | Docker |
|--------|-----------|------------|--------|
| **Environments** | 6 | 4 | 5 |
| **Key Strategy** | Per-environment unique | Mixed (unique + shared) | Single shared key |
| **Config Generation** | Static in repo | Dynamic `import-age-key` | Dynamic `import-age-key` |
| **Encryption Scope** | Full file | Selective (`data\|stringData`) | Mixed |
| **Edit Support** | Some (`edit-*`) | None | Yes (`edit-*`) |
| **Validation** | None | `validate` | `validate` |
| **Key Location** | `~/.config/sops/age/{env}.txt` | Local `age-key.txt` | Local `age-key.txt` |

### Current Target Inventory

**Terraform Targets**:

- `age-keygen` - Generate age encryption key
- `age-info` - Display age key information
- `encrypt-backend` - Encrypt backend.hcl
- `encrypt-tfvars` - Encrypt terraform.tfvars
- `edit-backend` - Edit encrypted backend.hcl (some envs)
- `edit-tfvars` - Edit encrypted terraform.tfvars (some envs)

**Kubernetes Targets**:

- `check-deps` - Verify sops and age installed
- `check-sops-config` - Verify .sops.yaml exists
- `import-age-key` - Import age key and generate .sops.yaml
- `secret-sops-age` - Generate SOPS age secret
- `secret-flux-git` - Generate Flux Git credentials secret
- `encrypt` / `encrypt-all` - Encrypt files
- `decrypt` / `decrypt-all` - Decrypt files
- `validate` - Validate encrypted secrets can be decrypted
- `clean` - Remove .decrypted files

**Docker Targets**:

- `import-age-key` - Import age key and generate .sops.yaml
- `encrypt` - Encrypt .env and docker-compose files
- `edit` / `edit-env` / `edit-override` - Edit encrypted files
- `validate` - Validate encrypted secrets can be decrypted
- `env` - Show decrypted .env
- `config` - Output merged docker-compose configuration

## Architecture

### Design Overview

```
infrastructure/
├── makefiles/
│   └── sops.mk                    # Shared SOPS operations (NEW)
│
├── terraform/environments/*/
│   ├── Makefile                   # Includes sops.mk + terraform-specific
│   └── .sops.yaml                 # Static (per-environment key)
│
├── kubernetes/overlays/*/
│   ├── Makefile                   # Includes sops.mk + k8s-specific
│   └── .sops.yaml                 # Dynamic (generated by import-age-key)
│
└── docker/overlays/*/
    ├── Makefile                   # Includes sops.mk + docker-specific
    └── .sops.yaml                 # Dynamic (generated by import-age-key)
```

### Shared Include File: `sops.mk`

The core of this design is a shared Makefile include that provides:

1. **Common Variables**: Standardized variable names with sensible defaults
2. **Core Targets**: Universal operations available everywhere
3. **Helper Functions**: Reusable shell functions for common patterns
4. **Validation Logic**: Consistent pre-flight checks

### Layered Architecture

```
┌─────────────────────────────────────────────────────────┐
│                    Domain Makefile                       │
│  (terraform-specific, k8s-specific, docker-specific)    │
├─────────────────────────────────────────────────────────┤
│                      sops.mk                             │
│           (shared operations & utilities)               │
├─────────────────────────────────────────────────────────┤
│                   SOPS + Age Tools                       │
│                (CLI binary execution)                   │
└─────────────────────────────────────────────────────────┘
```

## Standardized Targets

### Tier 1: Universal Targets (All Domains)

These targets MUST be available in every environment:

| Target | Description | Behavior |
|--------|-------------|----------|
| `sops-help` | Show SOPS operations help | Display available SOPS targets |
| `sops-check-deps` | Verify sops and age installed | Fail if missing, show versions |
| `sops-check-config` | Verify .sops.yaml exists | Fail if missing, show diagnostics |
| `sops-info` | Display encryption info | Show public key, config status |
| `sops-validate` | Validate all encrypted files | Test decryption without output |

### Tier 2: Key Management Targets

| Target | Description | When Available |
|--------|-------------|----------------|
| `sops-keygen` | Generate new age key pair | All domains |
| `sops-import-key` | Import existing age key | Kubernetes, Docker |
| `sops-rotate-key` | Rotate encryption key | All domains |
| `sops-export-public` | Export public key for sharing | All domains |

### Tier 3: Encryption Operations

| Target | Description | When Available |
|--------|-------------|----------------|
| `sops-encrypt` | Encrypt file(s) | All domains |
| `sops-decrypt` | Decrypt file(s) to stdout | All domains |
| `sops-edit` | Edit encrypted file in-place | All domains |
| `sops-rekey` | Re-encrypt with new key | All domains |

### Tier 4: Domain-Specific Targets

**Terraform**:

| Target | Description |
|--------|-------------|
| `sops-encrypt-backend` | Encrypt backend.hcl |
| `sops-encrypt-tfvars` | Encrypt terraform.tfvars |
| `sops-edit-backend` | Edit encrypted backend.hcl |
| `sops-edit-tfvars` | Edit encrypted terraform.tfvars |

**Kubernetes**:

| Target | Description |
|--------|-------------|
| `sops-encrypt-secret` | Encrypt Kubernetes secret manifest |
| `sops-decrypt-all` | Decrypt all .enc files |
| `sops-secret-age` | Generate cluster SOPS age secret |
| `sops-secret-git` | Generate Git credentials secret |

**Docker**:

| Target | Description |
|--------|-------------|
| `sops-encrypt-env` | Encrypt .env file |
| `sops-encrypt-compose` | Encrypt docker-compose override |
| `sops-edit-env` | Edit encrypted .env |
| `sops-show-env` | Display decrypted .env |

## Configuration

### Required Variables (Set by Domain Makefile)

```makefile
# Domain identifier (terraform|kubernetes|docker)
SOPS_DOMAIN := terraform

# Environment name (used for key naming)
SOPS_ENV_NAME := talos-cluster-shangkuei-dev

# Key file location strategy (central|local)
SOPS_KEY_STRATEGY := central

# Files to encrypt (space-separated patterns)
SOPS_ENCRYPT_PATTERNS := *.tfvars backend.hcl

# encrypted_regex setting (empty for full-file encryption)
SOPS_ENCRYPTED_REGEX :=
```

### Optional Variables (Defaults Provided)

```makefile
# Central key directory
SOPS_AGE_DIR ?= $(HOME)/.config/sops/age

# Local key filename (when using local strategy)
SOPS_LOCAL_KEY ?= age-key.txt

# SOPS configuration filename
SOPS_CONFIG ?= .sops.yaml

# Default editor for sops edit
SOPS_EDITOR ?= $(EDITOR)

# Color output
SOPS_COLOR ?= true
```

### Key Location Strategies

**Central Strategy** (Terraform):

```
~/.config/sops/age/
├── talos-cluster.txt           # Private key
├── talos-cluster.txt.pub       # Public key
├── gitops.txt
├── gitops.txt.pub
└── ...
```

**Local Strategy** (Kubernetes, Docker):

```
kubernetes/overlays/flux-instance/shangkuei-dev/
├── age-key.txt                 # Private key (gitignored)
├── .sops.yaml                  # Generated config
└── *.yaml.enc                  # Encrypted files
```

## Implementation

### sops.mk Core Structure

```makefile
# ============================================================================
# sops.mk - Unified SOPS Operations
# ============================================================================
# Include this file in domain Makefiles for standardized SOPS operations
#
# Required variables (must be set before including):
#   SOPS_DOMAIN        - Domain identifier (terraform|kubernetes|docker)
#   SOPS_ENV_NAME      - Environment name for key naming
#
# Optional variables:
#   SOPS_KEY_STRATEGY  - Key location (central|local), default: central
#   SOPS_AGE_DIR       - Central key directory
#   SOPS_LOCAL_KEY     - Local key filename
#   SOPS_CONFIG        - SOPS config filename
#   SOPS_ENCRYPTED_REGEX - Regex for selective encryption
# ============================================================================

# Defaults
SOPS_KEY_STRATEGY ?= central
SOPS_AGE_DIR ?= $(HOME)/.config/sops/age
SOPS_LOCAL_KEY ?= age-key.txt
SOPS_CONFIG ?= .sops.yaml
SOPS_EDITOR ?= $(EDITOR)
SOPS_COLOR ?= true

# Computed paths based on strategy
ifeq ($(SOPS_KEY_STRATEGY),central)
  SOPS_AGE_KEY_FILE := $(SOPS_AGE_DIR)/$(SOPS_ENV_NAME).txt
  SOPS_AGE_PUB_FILE := $(SOPS_AGE_DIR)/$(SOPS_ENV_NAME).txt.pub
else
  SOPS_AGE_KEY_FILE := $(CURDIR)/$(SOPS_LOCAL_KEY)
  SOPS_AGE_PUB_FILE :=
endif

# Colors (if enabled)
ifeq ($(SOPS_COLOR),true)
  SOPS_RED := \033[0;31m
  SOPS_GREEN := \033[0;32m
  SOPS_YELLOW := \033[0;33m
  SOPS_BLUE := \033[0;34m
  SOPS_NC := \033[0m
else
  SOPS_RED :=
  SOPS_GREEN :=
  SOPS_YELLOW :=
  SOPS_BLUE :=
  SOPS_NC :=
endif

# ============================================================================
# Tier 1: Universal Targets
# ============================================================================

.PHONY: sops-help
sops-help: ## Show SOPS operations help
 @echo "$(SOPS_BLUE)SOPS Operations ($(SOPS_DOMAIN)/$(SOPS_ENV_NAME))$(SOPS_NC)"
 @echo ""
 @echo "Key Management:"
 @echo "  sops-keygen        Generate new age key pair"
 @echo "  sops-import-key    Import existing age key (AGE_KEY_FILE=path)"
 @echo "  sops-info          Display encryption configuration"
 @echo "  sops-export-public Export public key for sharing"
 @echo ""
 @echo "Operations:"
 @echo "  sops-encrypt       Encrypt file (FILE=path)"
 @echo "  sops-decrypt       Decrypt file to stdout (FILE=path)"
 @echo "  sops-edit          Edit encrypted file (FILE=path)"
 @echo "  sops-validate      Validate all encrypted files"
 @echo ""
 @echo "Maintenance:"
 @echo "  sops-check-deps    Verify sops and age are installed"
 @echo "  sops-check-config  Verify .sops.yaml configuration"
 @echo "  sops-clean         Remove decrypted files"

.PHONY: sops-check-deps
sops-check-deps: ## Verify sops and age are installed
 @command -v sops >/dev/null 2>&1 || { \
  echo "$(SOPS_RED)Error: sops not installed$(SOPS_NC)"; \
  echo "Install: brew install sops"; \
  exit 1; \
 }
 @command -v age >/dev/null 2>&1 || { \
  echo "$(SOPS_RED)Error: age not installed$(SOPS_NC)"; \
  echo "Install: brew install age"; \
  exit 1; \
 }
 @echo "$(SOPS_GREEN)Dependencies OK$(SOPS_NC)"
 @echo "  sops: $$(sops --version 2>&1 | head -1)"
 @echo "  age:  $$(age --version 2>&1)"

.PHONY: sops-check-config
sops-check-config: ## Verify .sops.yaml configuration exists
 @if [ ! -f "$(SOPS_CONFIG)" ]; then \
  echo "$(SOPS_RED)Error: $(SOPS_CONFIG) not found$(SOPS_NC)"; \
  echo ""; \
  echo "To create configuration:"; \
  if [ "$(SOPS_KEY_STRATEGY)" = "central" ]; then \
   echo "  make sops-keygen"; \
  else \
   echo "  make sops-import-key AGE_KEY_FILE=/path/to/key.txt"; \
  fi; \
  exit 1; \
 fi
 @echo "$(SOPS_GREEN)Configuration OK: $(SOPS_CONFIG)$(SOPS_NC)"
 @echo "Public key(s):"
 @grep -E "age:" $(SOPS_CONFIG) | sed 's/^/  /'

.PHONY: sops-info
sops-info: sops-check-deps ## Display encryption configuration
 @echo "$(SOPS_BLUE)SOPS Configuration$(SOPS_NC)"
 @echo "  Domain:       $(SOPS_DOMAIN)"
 @echo "  Environment:  $(SOPS_ENV_NAME)"
 @echo "  Key Strategy: $(SOPS_KEY_STRATEGY)"
 @echo "  Key File:     $(SOPS_AGE_KEY_FILE)"
 @echo ""
 @if [ -f "$(SOPS_AGE_KEY_FILE)" ]; then \
  echo "$(SOPS_GREEN)Private key: Present$(SOPS_NC)"; \
  echo "Public key:"; \
  age-keygen -y "$(SOPS_AGE_KEY_FILE)" | sed 's/^/  /'; \
 else \
  echo "$(SOPS_YELLOW)Private key: Not found$(SOPS_NC)"; \
 fi
 @echo ""
 @if [ -f "$(SOPS_CONFIG)" ]; then \
  echo "$(SOPS_GREEN)Config file: $(SOPS_CONFIG)$(SOPS_NC)"; \
 else \
  echo "$(SOPS_YELLOW)Config file: Not found$(SOPS_NC)"; \
 fi

.PHONY: sops-validate
sops-validate: sops-check-deps sops-check-config ## Validate all encrypted files can be decrypted
 @echo "$(SOPS_BLUE)Validating encrypted files...$(SOPS_NC)"
 @if [ ! -f "$(SOPS_AGE_KEY_FILE)" ]; then \
  echo "$(SOPS_RED)Error: Private key not found: $(SOPS_AGE_KEY_FILE)$(SOPS_NC)"; \
  exit 1; \
 fi
 @FAILED=0; \
 for file in $$(find . -maxdepth 1 -name "*.enc" -o -name "*.enc.*" 2>/dev/null); do \
  if SOPS_AGE_KEY_FILE="$(SOPS_AGE_KEY_FILE)" sops -d "$$file" > /dev/null 2>&1; then \
   echo "  $(SOPS_GREEN)OK$(SOPS_NC) $$file"; \
  else \
   echo "  $(SOPS_RED)FAIL$(SOPS_NC) $$file"; \
   FAILED=1; \
  fi; \
 done; \
 if [ $$FAILED -eq 1 ]; then \
  echo "$(SOPS_RED)Validation failed$(SOPS_NC)"; \
  exit 1; \
 fi; \
 echo "$(SOPS_GREEN)All files validated successfully$(SOPS_NC)"

# ============================================================================
# Tier 2: Key Management Targets
# ============================================================================

.PHONY: sops-keygen
sops-keygen: sops-check-deps ## Generate new age key pair
 @if [ "$(SOPS_KEY_STRATEGY)" = "central" ]; then \
  mkdir -p "$(SOPS_AGE_DIR)"; \
  if [ -f "$(SOPS_AGE_KEY_FILE)" ]; then \
   echo "$(SOPS_YELLOW)Warning: Key already exists: $(SOPS_AGE_KEY_FILE)$(SOPS_NC)"; \
   read -p "Overwrite? [y/N] " confirm; \
   [ "$$confirm" = "y" ] || exit 0; \
  fi; \
  age-keygen -o "$(SOPS_AGE_KEY_FILE)" 2>&1; \
  chmod 600 "$(SOPS_AGE_KEY_FILE)"; \
  age-keygen -y "$(SOPS_AGE_KEY_FILE)" > "$(SOPS_AGE_PUB_FILE)"; \
  chmod 644 "$(SOPS_AGE_PUB_FILE)"; \
  echo ""; \
  echo "$(SOPS_GREEN)Key generated successfully$(SOPS_NC)"; \
  echo "  Private: $(SOPS_AGE_KEY_FILE)"; \
  echo "  Public:  $(SOPS_AGE_PUB_FILE)"; \
  echo ""; \
  echo "$(SOPS_YELLOW)IMPORTANT:$(SOPS_NC)"; \
  echo "  1. Backup private key to password manager"; \
  echo "  2. Update .sops.yaml with public key:"; \
  cat "$(SOPS_AGE_PUB_FILE)" | sed 's/^/     /'; \
 else \
  echo "Use 'make sops-import-key AGE_KEY_FILE=path' for local strategy"; \
 fi

.PHONY: sops-import-key
sops-import-key: sops-check-deps ## Import existing age key (AGE_KEY_FILE=path)
 @if [ -z "$(AGE_KEY_FILE)" ]; then \
  echo "$(SOPS_RED)Error: AGE_KEY_FILE not specified$(SOPS_NC)"; \
  echo "Usage: make sops-import-key AGE_KEY_FILE=/path/to/key.txt"; \
  exit 1; \
 fi
 @if [ ! -f "$(AGE_KEY_FILE)" ]; then \
  echo "$(SOPS_RED)Error: Key file not found: $(AGE_KEY_FILE)$(SOPS_NC)"; \
  exit 1; \
 fi
 @# Validate age key format
 @if ! grep -q "AGE-SECRET-KEY" "$(AGE_KEY_FILE)"; then \
  echo "$(SOPS_RED)Error: Invalid age key format$(SOPS_NC)"; \
  exit 1; \
 fi
 @# Copy key to local location
 @cp "$(AGE_KEY_FILE)" "$(SOPS_LOCAL_KEY)"
 @chmod 600 "$(SOPS_LOCAL_KEY)"
 @# Extract public key and generate .sops.yaml
 @PUBLIC_KEY=$$(age-keygen -y "$(SOPS_LOCAL_KEY)"); \
 $(call sops_generate_config,$$PUBLIC_KEY)
 @echo "$(SOPS_GREEN)Key imported successfully$(SOPS_NC)"
 @echo "  Private key: $(SOPS_LOCAL_KEY)"
 @echo "  Config:      $(SOPS_CONFIG)"

.PHONY: sops-export-public
sops-export-public: sops-check-deps ## Export public key for sharing
 @if [ ! -f "$(SOPS_AGE_KEY_FILE)" ]; then \
  echo "$(SOPS_RED)Error: Private key not found$(SOPS_NC)"; \
  exit 1; \
 fi
 @age-keygen -y "$(SOPS_AGE_KEY_FILE)"

# ============================================================================
# Tier 3: Encryption Operations
# ============================================================================

.PHONY: sops-encrypt
sops-encrypt: sops-check-deps sops-check-config ## Encrypt file (FILE=path)
 @if [ -z "$(FILE)" ]; then \
  echo "$(SOPS_RED)Error: FILE not specified$(SOPS_NC)"; \
  echo "Usage: make sops-encrypt FILE=path/to/file"; \
  exit 1; \
 fi
 @if [ ! -f "$(FILE)" ]; then \
  echo "$(SOPS_RED)Error: File not found: $(FILE)$(SOPS_NC)"; \
  exit 1; \
 fi
 @SOPS_AGE_KEY_FILE="$(SOPS_AGE_KEY_FILE)" sops --encrypt --in-place "$(FILE)"
 @echo "$(SOPS_GREEN)Encrypted: $(FILE)$(SOPS_NC)"

.PHONY: sops-decrypt
sops-decrypt: sops-check-deps sops-check-config ## Decrypt file to stdout (FILE=path)
 @if [ -z "$(FILE)" ]; then \
  echo "$(SOPS_RED)Error: FILE not specified$(SOPS_NC)"; \
  echo "Usage: make sops-decrypt FILE=path/to/file"; \
  exit 1; \
 fi
 @SOPS_AGE_KEY_FILE="$(SOPS_AGE_KEY_FILE)" sops --decrypt "$(FILE)"

.PHONY: sops-edit
sops-edit: sops-check-deps sops-check-config ## Edit encrypted file (FILE=path)
 @if [ -z "$(FILE)" ]; then \
  echo "$(SOPS_RED)Error: FILE not specified$(SOPS_NC)"; \
  echo "Usage: make sops-edit FILE=path/to/file"; \
  exit 1; \
 fi
 @EDITOR="$(SOPS_EDITOR)" SOPS_AGE_KEY_FILE="$(SOPS_AGE_KEY_FILE)" sops "$(FILE)"

.PHONY: sops-clean
sops-clean: ## Remove decrypted files
 @echo "$(SOPS_BLUE)Cleaning decrypted files...$(SOPS_NC)"
 @find . -maxdepth 1 -name "*.decrypted" -delete -print 2>/dev/null || true
 @find . -maxdepth 1 -name "*.decrypted.*" -delete -print 2>/dev/null || true
 @echo "$(SOPS_GREEN)Clean complete$(SOPS_NC)"

# ============================================================================
# Helper Functions (for domain-specific use)
# ============================================================================

# Generate .sops.yaml configuration
# Usage: $(call sops_generate_config,PUBLIC_KEY)
define sops_generate_config
 @echo "# SOPS configuration for $(SOPS_ENV_NAME)" > $(SOPS_CONFIG)
 @echo "# Generated: $$(date -Iseconds)" >> $(SOPS_CONFIG)
 @echo "creation_rules:" >> $(SOPS_CONFIG)
endef

# Add creation rule to .sops.yaml
# Usage: $(call sops_add_rule,PATH_REGEX,PUBLIC_KEY,[ENCRYPTED_REGEX])
define sops_add_rule
 @echo "  - path_regex: $(1)" >> $(SOPS_CONFIG)
 @if [ -n "$(3)" ]; then \
  echo "    encrypted_regex: '$(3)'" >> $(SOPS_CONFIG); \
 fi
 @echo "    age: $(2)" >> $(SOPS_CONFIG)
endef
```

### Domain-Specific Extensions

#### Terraform Extension

```makefile
# terraform/environments/{env}/Makefile
include ../../../makefiles/sops.mk

SOPS_DOMAIN := terraform
SOPS_ENV_NAME := talos-cluster-shangkuei-dev
SOPS_KEY_STRATEGY := central

# Terraform-specific files
BACKEND_HCL := backend.hcl
BACKEND_ENC := backend.enc.hcl
TFVARS_FILE := terraform.tfvars
TFVARS_ENC := terraform.enc.tfvars

# Domain-specific targets
.PHONY: sops-encrypt-backend
sops-encrypt-backend: sops-check-deps sops-check-config
 @SOPS_AGE_KEY_FILE="$(SOPS_AGE_KEY_FILE)" sops -e "$(BACKEND_HCL)" > "$(BACKEND_ENC)"
 @echo "$(SOPS_GREEN)Encrypted: $(BACKEND_ENC)$(SOPS_NC)"

.PHONY: sops-encrypt-tfvars
sops-encrypt-tfvars: sops-check-deps sops-check-config
 @SOPS_AGE_KEY_FILE="$(SOPS_AGE_KEY_FILE)" sops -e "$(TFVARS_FILE)" > "$(TFVARS_ENC)"
 @echo "$(SOPS_GREEN)Encrypted: $(TFVARS_ENC)$(SOPS_NC)"

.PHONY: sops-edit-backend
sops-edit-backend: sops-check-deps
 @EDITOR="$(SOPS_EDITOR)" SOPS_AGE_KEY_FILE="$(SOPS_AGE_KEY_FILE)" sops "$(BACKEND_ENC)"

.PHONY: sops-edit-tfvars
sops-edit-tfvars: sops-check-deps
 @EDITOR="$(SOPS_EDITOR)" SOPS_AGE_KEY_FILE="$(SOPS_AGE_KEY_FILE)" sops "$(TFVARS_ENC)"

# Override validate for terraform-specific patterns
.PHONY: sops-validate
sops-validate: sops-check-deps
 @echo "$(SOPS_BLUE)Validating encrypted files...$(SOPS_NC)"
 @FAILED=0; \
 for file in $(BACKEND_ENC) $(TFVARS_ENC); do \
  if [ -f "$$file" ]; then \
   if SOPS_AGE_KEY_FILE="$(SOPS_AGE_KEY_FILE)" sops -d "$$file" > /dev/null 2>&1; then \
    echo "  $(SOPS_GREEN)OK$(SOPS_NC) $$file"; \
   else \
    echo "  $(SOPS_RED)FAIL$(SOPS_NC) $$file"; \
    FAILED=1; \
   fi; \
  fi; \
 done; \
 [ $$FAILED -eq 0 ] && echo "$(SOPS_GREEN)Validation complete$(SOPS_NC)"
```

#### Kubernetes Extension

```makefile
# kubernetes/overlays/flux-instance/{env}/Makefile
include ../../../../makefiles/sops.mk

SOPS_DOMAIN := kubernetes
SOPS_ENV_NAME := flux-shangkuei-dev
SOPS_KEY_STRATEGY := local
SOPS_ENCRYPTED_REGEX := ^(data|stringData)$$

# Kubernetes-specific targets
.PHONY: sops-secret-age
sops-secret-age: sops-check-deps sops-check-config
 @echo "---" > secret-sops-age.yaml
 @echo "apiVersion: v1" >> secret-sops-age.yaml
 @echo "kind: Secret" >> secret-sops-age.yaml
 @echo "metadata:" >> secret-sops-age.yaml
 @echo "  name: sops-age" >> secret-sops-age.yaml
 @echo "  namespace: flux-system" >> secret-sops-age.yaml
 @echo "stringData:" >> secret-sops-age.yaml
 @echo "  keys.txt: |" >> secret-sops-age.yaml
 @sed 's/^/    /' "$(SOPS_LOCAL_KEY)" >> secret-sops-age.yaml
 @SOPS_AGE_KEY_FILE="$(SOPS_AGE_KEY_FILE)" sops --encrypt --in-place secret-sops-age.yaml
 @mv secret-sops-age.yaml secret-sops-age.yaml.enc
 @echo "$(SOPS_GREEN)Created: secret-sops-age.yaml.enc$(SOPS_NC)"

.PHONY: sops-decrypt-all
sops-decrypt-all: sops-check-deps sops-check-config
 @for file in *.enc *.yaml.enc; do \
  if [ -f "$$file" ]; then \
   outfile=$${file%.enc}.decrypted; \
   SOPS_AGE_KEY_FILE="$(SOPS_AGE_KEY_FILE)" sops -d "$$file" > "$$outfile"; \
   echo "$(SOPS_GREEN)Decrypted: $$outfile$(SOPS_NC)"; \
  fi; \
 done

# Override import-key to generate k8s-specific .sops.yaml
.PHONY: sops-import-key
sops-import-key: sops-check-deps
 @# ... (import logic) ...
 @PUBLIC_KEY=$$(age-keygen -y "$(SOPS_LOCAL_KEY)"); \
 echo "creation_rules:" > $(SOPS_CONFIG); \
 echo "  - path_regex: .*\\.(enc|yaml|yml)$$" >> $(SOPS_CONFIG); \
 echo "    encrypted_regex: '^(data|stringData)$$'" >> $(SOPS_CONFIG); \
 echo "    age: $$PUBLIC_KEY" >> $(SOPS_CONFIG)
```

#### Docker Extension

```makefile
# docker/overlays/{service}/{env}/Makefile
include ../../../../makefiles/sops.mk

SOPS_DOMAIN := docker
SOPS_ENV_NAME := $(SERVICE_NAME)-shangkuei-xyz-unraid
SOPS_KEY_STRATEGY := local

ENV_FILE := .env
OVERRIDE_FILE := docker-compose.override.yml

# Docker-specific targets
.PHONY: sops-encrypt-env
sops-encrypt-env: sops-check-deps sops-check-config
 @if [ -f "$(ENV_FILE)" ] && ! head -1 "$(ENV_FILE)" | grep -q "^sops:"; then \
  SOPS_AGE_KEY_FILE="$(SOPS_AGE_KEY_FILE)" sops --encrypt --in-place "$(ENV_FILE)"; \
  echo "$(SOPS_GREEN)Encrypted: $(ENV_FILE)$(SOPS_NC)"; \
 else \
  echo "$(SOPS_YELLOW)$(ENV_FILE) already encrypted or not found$(SOPS_NC)"; \
 fi

.PHONY: sops-edit-env
sops-edit-env: sops-check-deps
 @EDITOR="$(SOPS_EDITOR)" SOPS_AGE_KEY_FILE="$(SOPS_AGE_KEY_FILE)" sops "$(ENV_FILE)"

.PHONY: sops-show-env
sops-show-env: sops-check-deps
 @SOPS_AGE_KEY_FILE="$(SOPS_AGE_KEY_FILE)" sops -d "$(ENV_FILE)"

# Override import-key to generate docker-specific .sops.yaml
.PHONY: sops-import-key
sops-import-key: sops-check-deps
 @# ... (import logic) ...
 @PUBLIC_KEY=$$(age-keygen -y "$(SOPS_LOCAL_KEY)"); \
 echo "creation_rules:" > $(SOPS_CONFIG); \
 echo "  - path_regex: \\.env$$" >> $(SOPS_CONFIG); \
 echo "    age: $$PUBLIC_KEY" >> $(SOPS_CONFIG); \
 echo "  - path_regex: docker-compose\\.(.*\\.)?override\\.yml$$" >> $(SOPS_CONFIG); \
 echo "    age: $$PUBLIC_KEY" >> $(SOPS_CONFIG)
```

## Migration Plan

### Phase 1: Create Shared Infrastructure (Week 1)

1. Create `makefiles/` directory at repository root
2. Implement `sops.mk` with Tier 1 & 2 targets
3. Add comprehensive tests for shared functions
4. Document usage in `makefiles/README.md`

### Phase 2: Migrate Terraform Environments (Week 2)

1. Update one Terraform environment as pilot (e.g., `talos-cluster-shangkuei-dev`)
2. Add `include` statement to existing Makefile
3. Add domain-specific extensions
4. Verify backward compatibility (old targets still work)
5. Migrate remaining Terraform environments

### Phase 3: Migrate Kubernetes Overlays (Week 3)

1. Update Flux instance overlays
2. Update ArgoCD project overlays
3. Standardize `.sops.yaml` generation
4. Add cluster-specific secret generation targets

### Phase 4: Migrate Docker Overlays (Week 4)

1. Update all Docker service overlays
2. Standardize key management (consider per-service vs shared)
3. Add service-specific edit targets

### Phase 5: Cleanup & Documentation (Week 5)

1. Remove duplicate code from domain Makefiles
2. Update runbook: `docs/runbooks/0008-sops-secret-management.md`
3. Create quick reference card
4. Archive old Makefile patterns

## Backward Compatibility

### Preserved Targets

These existing targets will continue to work as aliases:

| Old Target | New Target | Domain |
|------------|------------|--------|
| `age-keygen` | `sops-keygen` | Terraform |
| `age-info` | `sops-info` | Terraform |
| `encrypt-backend` | `sops-encrypt-backend` | Terraform |
| `encrypt-tfvars` | `sops-encrypt-tfvars` | Terraform |
| `import-age-key` | `sops-import-key` | Kubernetes, Docker |
| `encrypt` | `sops-encrypt` | All |
| `decrypt` | `sops-decrypt` | All |
| `validate` | `sops-validate` | All |

### Alias Implementation

```makefile
# Backward compatibility aliases
age-keygen: sops-keygen
age-info: sops-info
encrypt-backend: sops-encrypt-backend
import-age-key: sops-import-key
encrypt: sops-encrypt
validate: sops-validate
```

## Security Considerations

### Key File Protection

- Private keys must have `chmod 600` permissions
- `.gitignore` must exclude `age-key.txt` and `*.txt` in key directories
- Central keys stored in user-specific directory (`~/.config/sops/age/`)

### Audit Trail

- All encryption operations logged with timestamps
- `.sops.yaml` changes tracked in Git history
- Consider adding `--verbose` flag for detailed operation logging

### Key Rotation

Unified key rotation procedure:

```bash
# 1. Generate new key
make sops-keygen SOPS_ENV_NAME=talos-cluster-new

# 2. Update .sops.yaml with both keys (transition period)
# 3. Re-encrypt all files
make sops-rekey

# 4. Remove old key from .sops.yaml
# 5. Update GitHub Secrets
# 6. Delete old key file
```

## Testing Strategy

### Unit Tests

Test each Makefile target in isolation:

```bash
# Test dependency check
make sops-check-deps

# Test config validation
make sops-check-config

# Test key generation (in temp directory)
make sops-keygen SOPS_AGE_DIR=/tmp/test-keys

# Test encryption/decryption cycle
echo "test: secret" > /tmp/test.yaml
make sops-encrypt FILE=/tmp/test.yaml
make sops-decrypt FILE=/tmp/test.yaml
```

### Integration Tests

Test domain-specific workflows:

```bash
# Terraform workflow
cd terraform/environments/talos-cluster-shangkuei-dev
make sops-validate
make sops-edit-tfvars  # Opens editor, verify re-encryption

# Kubernetes workflow
cd kubernetes/overlays/flux-instance/shangkuei-dev
make sops-import-key AGE_KEY_FILE=~/keys/test.txt
make sops-secret-age
make sops-validate
```

## Monitoring and Alerting

### Health Checks

Add CI job to validate all encrypted files:

```yaml
name: SOPS Validation
on: [push, pull_request]
jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install tools
        run: |
          brew install sops age
      - name: Validate Terraform secrets
        env:
          SOPS_AGE_KEY: ${{ secrets.SOPS_AGE_KEY_TERRAFORM }}
        run: |
          for dir in terraform/environments/*/; do
            if [ -f "$dir/Makefile" ]; then
              cd "$dir" && make sops-validate && cd -
            fi
          done
```

## Dependencies

- **sops**: >= 3.8.0
- **age**: >= 1.1.0
- **GNU Make**: >= 4.0 (for `define` functions)
- **bash**: >= 4.0 (for associative arrays if needed)

## References

- [ADR-0008: Secret Management Strategy](../../docs/decisions/0008-secret-management.md)
- [Runbook: SOPS Secret Management Operations](../../docs/runbooks/0008-sops-secret-management.md)
- [SOPS Documentation](https://github.com/getsops/sops)
- [age Encryption](https://age-encryption.org/)

## Revision History

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2025-12-02 | Infrastructure Team | Initial specification |
