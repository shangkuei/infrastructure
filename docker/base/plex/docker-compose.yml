# Plex Media Server
# Base configuration - override with environment-specific settings
#
# Metrics: plex-media-server-exporter at :9594/metrics (requires PLEX_TOKEN)
# Docs: https://github.com/axsuul/plex-media-server-exporter

name: plex

services:
  plex:
    image: plexinc/pms-docker:${PLEX_VERSION:-latest}
    container_name: plex
    restart: unless-stopped
    environment:
      - TZ=${TZ:-UTC}
      - PLEX_CLAIM=${PLEX_CLAIM:-}
      - PLEX_UID=${PLEX_UID:-1000}
      - PLEX_GID=${PLEX_GID:-1000}
      - ADVERTISE_IP=${PLEX_ADVERTISE_IP:-}
    volumes:
      - plex_config:/config
      - plex_transcode:/transcode
    ports:
      - "${PLEX_PORT:-32400}:32400/tcp"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:32400/identity"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Prometheus metrics exporter for Plex Media Server
  # Exports: library counts, session states, transcode metrics
  plex-exporter:
    image: ghcr.io/axsuul/plex-media-server-exporter:latest
    container_name: plex_exporter
    restart: unless-stopped
    depends_on:
      plex:
        condition: service_healthy
    environment:
      - PLEX_ADDR=http://plex:32400
      - PLEX_TOKEN=${PLEX_TOKEN}
    networks:
      - plex
    # Metrics exposed at :9594/metrics

volumes:
  plex_config:
    driver: local
  plex_transcode:
    driver: local

networks:
  plex:
    name: plex-internal
