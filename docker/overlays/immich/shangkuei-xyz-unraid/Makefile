# Makefile for Immich secrets management
SHELL := /bin/bash
.DEFAULT_GOAL := help

# Configuration
SERVICE_NAME := immich
BASE_DIR := ../../../base/$(SERVICE_NAME)
AGE_KEY_FILE ?= age-key.txt

# Encrypted files (committed to git)
ENV_FILE := .env
OVERRIDE_FILE := docker-compose.override.yml
TRAEFIK_FILE := docker-compose.traefik.override.yml
TAILSCALE_FILE := docker-compose.tailscale.override.yml
TAILSCALE_RAW_FILE := docker-compose.tailscale.override.raw.yml

# Base compose file
BASE_COMPOSE := $(BASE_DIR)/docker-compose.yml

.PHONY: help
help: ## Show this help message
	@echo "Immich Secrets Management"
	@echo ""
	@echo "Usage: make [target]"
	@echo ""
	@echo "Targets:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  %-20s %s\n", $$1, $$2}'

.PHONY: import-age-key
import-age-key: ## Import Age key and generate .sops.yaml
	@if [ -z "$(AGE_KEY_FILE)" ]; then \
		echo "Error: AGE_KEY_FILE not specified"; \
		echo "Usage: make import-age-key AGE_KEY_FILE=/path/to/age-key.txt"; \
		exit 1; \
	fi
	@if [ ! -f "$(AGE_KEY_FILE)" ]; then \
		echo "Error: Age key file not found: $(AGE_KEY_FILE)"; \
		exit 1; \
	fi
	@cp "$(AGE_KEY_FILE)" age-key.txt
	@PUBLIC_KEY=$$(grep -o 'age1[a-z0-9]*' age-key.txt | head -1); \
	echo "# SOPS configuration for $(SERVICE_NAME) secrets" > .sops.yaml; \
	echo "# Auto-generated by: make import-age-key" >> .sops.yaml; \
	echo "" >> .sops.yaml; \
	echo "creation_rules:" >> .sops.yaml; \
	echo "  # Environment file" >> .sops.yaml; \
	echo "  - path_regex: \\.env$$" >> .sops.yaml; \
	echo "    age: $$PUBLIC_KEY" >> .sops.yaml; \
	echo "" >> .sops.yaml; \
	echo "  # Docker compose override files" >> .sops.yaml; \
	echo "  # - docker-compose.override.yml (general)" >> .sops.yaml; \
	echo "  # - docker-compose.{category}.override.yml (category-specific)" >> .sops.yaml; \
	echo "  - path_regex: docker-compose\\.(.*\\.)?override\\.yml$$" >> .sops.yaml; \
	echo "    age: $$PUBLIC_KEY" >> .sops.yaml
	@echo "Age key imported and .sops.yaml generated"

.PHONY: encrypt
encrypt: ## Encrypt plaintext files (first-time setup)
	@export SOPS_AGE_KEY_FILE=$(AGE_KEY_FILE); \
	echo "Encrypting files in-place..."; \
	if [ -f "$(ENV_FILE)" ] && ! head -1 "$(ENV_FILE)" | grep -q "^sops:"; then \
		sops --encrypt --in-place $(ENV_FILE); \
		echo "Encrypted $(ENV_FILE)"; \
	fi; \
	if [ -f "$(OVERRIDE_FILE)" ] && ! head -1 "$(OVERRIDE_FILE)" | grep -q "^#ENC"; then \
		sops --encrypt --in-place $(OVERRIDE_FILE); \
		echo "Encrypted $(OVERRIDE_FILE)"; \
	fi; \
	if [ -f "$(TRAEFIK_FILE)" ] && ! head -1 "$(TRAEFIK_FILE)" | grep -q "^#ENC"; then \
		sops --encrypt --in-place $(TRAEFIK_FILE); \
		echo "Encrypted $(TRAEFIK_FILE)"; \
	fi; \
	if [ -f "$(TAILSCALE_FILE)" ] && ! head -1 "$(TAILSCALE_FILE)" | grep -q "^#ENC"; then \
		sops --encrypt --in-place $(TAILSCALE_FILE); \
		echo "Encrypted $(TAILSCALE_FILE)"; \
	fi

.PHONY: edit
edit: ## Edit encrypted file with sops (interactive menu)
	@echo "Select file to edit:"
	@echo "  1) .env"
	@echo "  2) docker-compose.override.yml"
	@echo "  3) docker-compose.traefik.override.yml"
	@echo "  4) docker-compose.tailscale.override.yml"
	@export SOPS_AGE_KEY_FILE=$(AGE_KEY_FILE); \
	read -p "Choice [1-4]: " choice; \
	case $$choice in \
		1) sops $(ENV_FILE) ;; \
		2) sops $(OVERRIDE_FILE) ;; \
		3) sops $(TRAEFIK_FILE) ;; \
		4) sops $(TAILSCALE_FILE) ;; \
		*) echo "Invalid choice" ;; \
	esac

.PHONY: edit-env
edit-env: ## Edit .env with sops
	@SOPS_AGE_KEY_FILE=$(AGE_KEY_FILE) sops $(ENV_FILE)

.PHONY: edit-override
edit-override: ## Edit docker-compose.override.yml with sops
	@SOPS_AGE_KEY_FILE=$(AGE_KEY_FILE) sops $(OVERRIDE_FILE)

.PHONY: edit-traefik
edit-traefik: ## Edit docker-compose.traefik.override.yml with sops
	@SOPS_AGE_KEY_FILE=$(AGE_KEY_FILE) sops $(TRAEFIK_FILE)

.PHONY: edit-tailscale
edit-tailscale: ## Edit docker-compose.tailscale.override.yml with sops
	@SOPS_AGE_KEY_FILE=$(AGE_KEY_FILE) sops $(TAILSCALE_FILE)

.PHONY: validate
validate: ## Validate all encrypted secrets can be decrypted
	@export SOPS_AGE_KEY_FILE=$(AGE_KEY_FILE); \
	echo "Validating encrypted files..."; \
	if [ -f "$(ENV_FILE)" ]; then \
		sops --decrypt $(ENV_FILE) > /dev/null && echo "✓ $(ENV_FILE)"; \
	fi; \
	if [ -f "$(OVERRIDE_FILE)" ]; then \
		sops --decrypt $(OVERRIDE_FILE) > /dev/null && echo "✓ $(OVERRIDE_FILE)"; \
	fi; \
	if [ -f "$(TRAEFIK_FILE)" ]; then \
		sops --decrypt $(TRAEFIK_FILE) > /dev/null && echo "✓ $(TRAEFIK_FILE)"; \
	fi; \
	if [ -f "$(TAILSCALE_FILE)" ]; then \
		sops --decrypt $(TAILSCALE_FILE) > /dev/null && echo "✓ $(TAILSCALE_FILE)"; \
	fi; \
	echo "Validation complete"

.PHONY: env
env: ## Show decrypted .env file
	@SOPS_AGE_KEY_FILE=$(AGE_KEY_FILE) sops -d $(ENV_FILE)

.PHONY: config
config: ## Output merged docker-compose configuration (Traefik + Tailscale)
	@export SOPS_AGE_KEY_FILE=$(AGE_KEY_FILE); \
	tmpdir=$$(mktemp -d); \
	trap "rm -rf $$tmpdir" EXIT; \
	sops -d $(OVERRIDE_FILE) > $$tmpdir/override.yml; \
	sops -d $(TRAEFIK_FILE) > $$tmpdir/traefik.yml; \
	sops -d $(TAILSCALE_FILE) > $$tmpdir/tailscale.yml; \
	docker compose --project-directory . \
		-f $(BASE_COMPOSE) \
		-f $$tmpdir/override.yml \
		-f $$tmpdir/traefik.yml \
		-f $$tmpdir/tailscale.yml \
		config --no-interpolate
